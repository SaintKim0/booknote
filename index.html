<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d10" />
  <title>ë…ì„œê¸°ë¡ì¥</title>
  <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22ë…ì„œê¸°ë¡ì¥%22,%22short_name%22:%22ë…ì„œê¸°ë¡%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%230b0d10%22,%22theme_color%22:%22%230b0d10%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect fill='%237dd3fc' width='100' height='100' rx='20'/%3E%3Ctext x='50' y='70' font-size='60' text-anchor='middle' fill='%230b0d10'%3EğŸ“š%3C/text%3E%3C/svg%3E%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}" />
  <style>
    :root{
      --bg:#0b0d10;
      --card:#12161c;
      --muted:#9aa4b2;
      --text:#e8edf3;
      --line:#243041;
      --accent:#7dd3fc;
      --danger:#fb7185;
      --ok:#86efac;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --font-scale: 1;
    }
    body{font-size: calc(14px * var(--font-scale));}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(1200px 800px at 80% 20%, rgba(134,239,172,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: rgba(125,211,252,.2);
      -webkit-touch-callout: none;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 22px 14px 60px;}
    @media (max-width: 640px){
      .wrap{padding: 16px 12px 50px;}
    }
    header{
      display:flex; gap:12px; align-items:baseline; justify-content:space-between;
      margin: 8px 2px 14px;
    }
    @media (max-width: 640px){
      header{flex-direction: column; gap:6px; align-items:flex-start;}
    }
    h1{font-size: 22px; margin:0; letter-spacing:-0.3px}
    @media (max-width: 640px){
      h1{font-size: 20px;}
    }
    .sub{color:var(--muted); font-size: 13px}
    @media (max-width: 640px){
      .sub{font-size: 12px;}
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{font-size:16px; margin: 2px 0 10px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 520px){
      .row{grid-template-columns: 1fr}
    }
    label{display:block; font-size: 12px; color:var(--muted); margin: 0 0 6px}
    @media (max-width: 640px){
      label{font-size: 13px;}
    }
    input, textarea, select{
      width:100%;
      background: rgba(10,12,16,.6);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 11px 12px;
      outline: none;
      font-size: 16px;
      font-family: inherit;
    }
    @media (max-width: 640px){
      input, textarea, select{
        padding: 14px 12px;
        font-size: 16px;
        border-radius: 10px;
      }
    }
    textarea{min-height: 92px; resize: vertical; line-height:1.5}
    @media (max-width: 640px){
      textarea{min-height: 110px;}
    }
    input:focus, textarea:focus, select:focus{border-color: rgba(125,211,252,.55); box-shadow: 0 0 0 3px rgba(125,211,252,.12)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px}
    button{
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(125,211,252,.16);
      color: var(--text);
      cursor:pointer;
      font-weight: 650;
      font-size: 14px;
      min-height: 44px;
      font-family: inherit;
      touch-action: manipulation;
    }
    @media (max-width: 640px){
      button{
        padding: 13px 16px;
        font-size: 15px;
        min-height: 48px;
        border-radius: 10px;
      }
    }
    button:hover{filter: brightness(1.08)}
    button:active{transform: scale(0.97)}
    button.secondary{background: rgba(255,255,255,.08); font-weight: 600}
    button.danger{background: rgba(251,113,133,.18)}
    button.ok{background: rgba(134,239,172,.16)}
    .hint{color:var(--muted); font-size: 12px; margin-top: 8px; line-height:1.4}
    @media (max-width: 640px){
      .hint{font-size: 13px;}
    }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin: 14px 2px;
    }
    @media (max-width: 640px){
      .toolbar{gap:8px; margin: 12px 0;}
      .toolbar .left{width:100%;}
      .toolbar .right{width:100%; justify-content:space-between;}
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px 12px;
      border-radius: 999px;
    }
    .pill input{border:0; background: transparent; padding:0; width: 240px; font-size: 15px;}
    @media (max-width: 640px){
      .pill{width:100%; padding: 12px 14px;}
      .pill input{width:100%; font-size: 16px; padding: 2px 0;}
    }
    .list{
      display:grid; gap:12px;
    }
    .entry{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      padding: 12px 12px 10px;
    }
    @media (max-width: 640px){
      .entry{padding: 14px;}
    }
    .entryTop{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
    }
    @media (max-width: 640px){
      .entryTop{flex-direction: column; gap:12px;}
    }
    .titleLine{display:flex; flex-wrap:wrap; gap:8px; align-items:baseline}
    .bookTitle{font-size: 16px; font-weight: 800; letter-spacing:-.2px}
    @media (max-width: 640px){
      .bookTitle{font-size: 17px;}
    }
    .meta{color:var(--muted); font-size: 12px}
    @media (max-width: 640px){
      .meta{font-size: 13px;}
    }
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top: 8px}
    .chip{
      font-size: 12px; color: var(--text);
      background: rgba(125,211,252,.10);
      border: 1px solid rgba(125,211,252,.18);
      padding: 5px 9px;
      border-radius: 999px;
    }
    @media (max-width: 640px){
      .chip{font-size: 13px; padding: 6px 11px;}
    }
    .summary{
      margin-top: 10px;
      color: rgba(232,237,243,.92);
      line-height: 1.55;
      white-space: pre-wrap;
      font-size: 14px;
    }
    @media (max-width: 640px){
      .summary{font-size: 15px; line-height: 1.6;}
    }
    .entryBtns{display:flex; gap:8px; flex-wrap:wrap}
    @media (max-width: 640px){
      .entryBtns{width:100%;}
    }
    .smallBtn{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(255,255,255,.08);
      min-height: 36px;
      font-family: inherit;
      touch-action: manipulation;
    }
    @media (max-width: 640px){
      .smallBtn{
        padding: 11px 14px;
        font-size: 14px;
        min-height: 44px;
        flex: 1;
      }
    }
    .smallBtn:hover{filter: brightness(1.08)}
    .smallBtn:active{transform: scale(0.97)}
    .smallBtn.danger{background: rgba(251,113,133,.16)}
    .smallBtn.ok{background: rgba(134,239,172,.14)}
    .divider{
      height:1px; background: rgba(255,255,255,.08); margin: 12px 0;
    }
    .footerNote{
      margin-top: 18px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }
    @media (max-width: 640px){
      .footerNote{font-size: 13px;}
    }
    .empty{
      color: var(--muted);
      padding: 22px 10px;
      text-align:center;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
    }
    /* ëª¨ë‹¬ */
    .modal{
      display:none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show{display:flex;}
    .modalContent{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      max-width: 450px;
      width: 100%;
      padding: 24px;
      animation: modalIn .2s ease;
    }
    @keyframes modalIn{
      from{opacity:0; transform: scale(0.95)}
      to{opacity:1; transform: scale(1)}
    }
    .modalHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modalHeader h3{margin:0; font-size: 18px;}
    .closeBtn{
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      min-height: auto;
      line-height: 1;
    }
    .closeBtn:hover{color: var(--text)}
    .settingItem{margin-bottom: 20px;}
    .settingItem label{display:block; margin-bottom: 10px; font-size: 14px; color: var(--text);}
    .scaleOptions{display:flex; gap:8px; flex-wrap:wrap;}
    .scaleBtn{
      flex: 1;
      min-width: 70px;
      background: rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.08);
      padding: 12px 8px;
      border-radius: 10px;
      font-size: 14px;
      min-height: auto;
    }
    .scaleBtn.active{
      background: rgba(125,211,252,.16);
      border-color: rgba(125,211,252,.4);
    }
    .previewText{
      margin-top: 12px;
      padding: 16px;
      background: rgba(0,0,0,.3);
      border-radius: 12px;
      color: var(--muted);
      font-size: calc(14px * var(--font-scale));
      line-height: 1.5;
    }
    .settingIcon{
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      transition: all .2s;
      user-select: none;
    }
    .settingIcon:hover{
      background: rgba(255,255,255,.1);
      transform: rotate(30deg);
    }
    @media print{
      body{background:#fff; color:#000}
      .card, .entry{box-shadow:none}
      .noPrint{display:none !important}
      .wrap{max-width: 900px}
      .entry{break-inside: avoid}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ë…ì„œê¸°ë¡ì¥</h1>
        <div class="sub">ì•„ì£¼ ê°„ë‹¨í•˜ê²Œ: ë‚ ì§œ Â· ì±… Â· ìš”ì•½</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="sub noPrint" id="countLabel"></div>
        <span class="settingIcon noPrint" id="openSettings" title="ì„¤ì •">âš™ï¸</span>
      </div>
    </header>

    <div class="grid">
      <!-- ì…ë ¥ -->
      <section class="card noPrint" aria-label="ìƒˆ ê¸°ë¡">
        <h2 id="formTitle">ìƒˆ ê¸°ë¡</h2>

        <div class="row">
          <div>
            <label for="date">ë‚ ì§œ *</label>
            <input id="date" type="date" />
          </div>
          <div>
            <label for="rating">ë³„ì </label>
            <select id="rating">
              <option value="0">ì„ íƒ ì•ˆ í•¨</option>
              <option value="1">â˜…</option>
              <option value="2">â˜…â˜…</option>
              <option value="3">â˜…â˜…â˜…</option>
              <option value="4">â˜…â˜…â˜…â˜…</option>
              <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
            </select>
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="title">ì±… ì œëª© *</label>
            <input id="title" type="text" placeholder="ì˜ˆ) ë°ë¯¸ì•ˆ" maxlength="80" />
          </div>
          <div>
            <label for="author">ì €ì</label>
            <input id="author" type="text" placeholder="ì˜ˆ) í—¤ë¥´ë§Œ í—¤ì„¸" maxlength="60" />
          </div>
        </div>

        <div class="row" style="margin-top:10px;">
          <div>
            <label for="progress">ì§„ë„/í˜ì´ì§€</label>
            <input id="progress" type="text" placeholder="ì˜ˆ) 1~80p / 30%" maxlength="30" />
          </div>
          <div>
            <label for="tags">íƒœê·¸(ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
            <input id="tags" type="text" placeholder="ì˜ˆ) ì†Œì„¤, ì„±ì¥, ì¸ìƒ" maxlength="60" />
          </div>
        </div>

        <div style="margin-top:10px;">
          <label for="summary">ê°„ë‹¨ ìš”ì•½ *</label>
          <textarea id="summary" placeholder="ì§§ê²Œ: ì–´ë–¤ ë‚´ìš©ì´ì—ˆëŠ”ì§€, ê¸°ì–µí•  í¬ì¸íŠ¸ë§Œ" maxlength="600"></textarea>
        </div>

        <div class="actions">
          <button id="saveBtn" class="ok">ì €ì¥</button>
          <button id="resetBtn" class="secondary">ì´ˆê¸°í™”</button>
          <button id="cancelEditBtn" class="secondary" style="display:none;">í¸ì§‘ ì·¨ì†Œ</button>
        </div>
        <div class="hint">* ëŠ” í•„ìˆ˜. ì €ì¥í•˜ë©´ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë¼ìš”(ì´ PC/ë¸Œë¼ìš°ì €ì—ì„œë§Œ ìœ ì§€).</div>

        <div class="divider"></div>

        <div class="actions">
          <button id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <button id="importBtn" class="secondary">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
          <button id="printBtn" class="secondary">ì¸ì‡„</button>
          <button id="wipeBtn" class="danger">ì „ì²´ ì‚­ì œ</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
      </section>

      <!-- ëª©ë¡/ê²€ìƒ‰ -->
      <section class="card" aria-label="ê¸°ë¡ ëª©ë¡">
        <h2>ê¸°ë¡</h2>

        <div class="toolbar noPrint">
          <div class="left">
            <div class="pill" title="ì œëª©/ì €ì/ìš”ì•½/íƒœê·¸ ê²€ìƒ‰">
              ğŸ” <input id="q" type="text" placeholder="ê²€ìƒ‰..." />
            </div>
          </div>
          <div class="right">
            <label class="sub" style="margin:0;">ì •ë ¬</label>
            <select id="sort" aria-label="ì •ë ¬">
              <option value="new">ìµœì‹ ìˆœ</option>
              <option value="old">ì˜¤ë˜ëœìˆœ</option>
            </select>
          </div>
        </div>

        <div id="list" class="list"></div>

        <div class="footerNote">
          íŒ: ì œëª©ì— â€œì™„ë…/ì¤‘ë‹¨â€ ê°™ì€ ë‹¨ì–´ë¥¼ ë¶™ì´ê±°ë‚˜, íƒœê·¸ì— â€œì™„ë…â€ì„ ë„£ìœ¼ë©´ ì°¾ê¸° ì‰¬ì›Œìš”.
        </div>
      </section>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>âš™ï¸ ì„¤ì •</h3>
        <button class="closeBtn" id="closeSettings" aria-label="ë‹«ê¸°">&times;</button>
      </div>

      <div class="settingItem">
        <label>í…ìŠ¤íŠ¸ í¬ê¸°</label>
        <div class="scaleOptions">
          <button class="scaleBtn" data-scale="0.85">ì‘ê²Œ</button>
          <button class="scaleBtn active" data-scale="1">ë³´í†µ</button>
          <button class="scaleBtn" data-scale="1.15">í¬ê²Œ</button>
          <button class="scaleBtn" data-scale="1.3">ì•„ì£¼ í¬ê²Œ</button>
        </div>
        <div class="previewText">
          ë¯¸ë¦¬ë³´ê¸°: ìƒˆë“¤ì€ ì•Œì—ì„œ ë‚˜ì˜¤ë ¤ê³  íˆ¬ìŸí•œë‹¤. ì•Œì€ ì„¸ê³„ì´ë‹¤. íƒœì–´ë‚˜ë ¤ëŠ” ìëŠ” í•˜ë‚˜ì˜ ì„¸ê³„ë¥¼ ê¹¨ëœ¨ë ¤ì•¼ í•œë‹¤.
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== ì €ì¥ í‚¤ ======
    const STORAGE_KEY = "reading_log_simple_v1";
    const SETTINGS_KEY = "reading_log_settings_v1";

    // ====== DOM ======
    const $ = (id) => document.getElementById(id);
    const els = {
      countLabel: $("countLabel"),
      formTitle: $("formTitle"),
      date: $("date"),
      title: $("title"),
      author: $("author"),
      progress: $("progress"),
      tags: $("tags"),
      rating: $("rating"),
      summary: $("summary"),
      saveBtn: $("saveBtn"),
      resetBtn: $("resetBtn"),
      cancelEditBtn: $("cancelEditBtn"),
      exportBtn: $("exportBtn"),
      importBtn: $("importBtn"),
      importFile: $("importFile"),
      printBtn: $("printBtn"),
      wipeBtn: $("wipeBtn"),
      q: $("q"),
      sort: $("sort"),
      list: $("list"),
      openSettings: $("openSettings"),
      closeSettings: $("closeSettings"),
      settingsModal: $("settingsModal"),
    };

    // ====== ìƒíƒœ ======
    /** @type {{items:any[], editingId: string|null}} */
    const state = {
      items: [],
      editingId: null,
    };

    // ====== ì„¤ì • ê´€ë¦¬ ======
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        return raw ? JSON.parse(raw) : {fontScale: 1};
      }catch(e){
        return {fontScale: 1};
      }
    }

    function saveSettings(settings){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function applyFontScale(scale){
      document.documentElement.style.setProperty('--font-scale', scale);
      // ë²„íŠ¼ active ìƒíƒœ ì—…ë°ì´íŠ¸
      document.querySelectorAll('.scaleBtn').forEach(btn => {
        btn.classList.toggle('active', parseFloat(btn.getAttribute('data-scale')) === scale);
      });
    }

    // ì„¤ì • ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
    els.openSettings.addEventListener('click', () => {
      els.settingsModal.classList.add('show');
    });

    els.closeSettings.addEventListener('click', () => {
      els.settingsModal.classList.remove('show');
    });

    els.settingsModal.addEventListener('click', (e) => {
      if(e.target === els.settingsModal){
        els.settingsModal.classList.remove('show');
      }
    });

    // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
    document.addEventListener('keydown', (e) => {
      if(e.key === 'Escape' && els.settingsModal.classList.contains('show')){
        els.settingsModal.classList.remove('show');
      }
    });

    // í…ìŠ¤íŠ¸ í¬ê¸° ë²„íŠ¼
    document.querySelectorAll('.scaleBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const scale = parseFloat(btn.getAttribute('data-scale'));
        applyFontScale(scale);
        const settings = loadSettings();
        settings.fontScale = scale;
        saveSettings(settings);
      });
    });

    // ====== ìœ í‹¸ ======
    function uid(){
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }
    function nowTs(){ return Date.now(); }

    function safeTrim(s){ return (s ?? "").toString().trim(); }

    function parseTags(input){
      const raw = safeTrim(input);
      if(!raw) return [];
      return raw
        .split(",")
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0, 12);
    }

    function formatStars(n){
      const k = Number(n) || 0;
      if(k <= 0) return "";
      return "â˜…".repeat(k);
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ====== ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ======
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        state.items = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(state.items)) state.items = [];
      }catch(e){
        state.items = [];
      }
    }

    function persist(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
    }

    // ====== í¼ ======
    function setDefaultDate(){
      if(!els.date.value){
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        els.date.value = `${yyyy}-${mm}-${dd}`;
      }
    }

    function resetForm(){
      state.editingId = null;
      els.formTitle.textContent = "ìƒˆ ê¸°ë¡";
      els.saveBtn.textContent = "ì €ì¥";
      els.cancelEditBtn.style.display = "none";

      els.title.value = "";
      els.author.value = "";
      els.progress.value = "";
      els.tags.value = "";
      els.rating.value = "0";
      els.summary.value = "";
      els.date.value = "";
      setDefaultDate();
      els.title.focus();
    }

    function fillFormForEdit(item){
      state.editingId = item.id;
      els.formTitle.textContent = "ê¸°ë¡ í¸ì§‘";
      els.saveBtn.textContent = "ìˆ˜ì • ì €ì¥";
      els.cancelEditBtn.style.display = "inline-block";

      els.date.value = item.date || "";
      els.title.value = item.title || "";
      els.author.value = item.author || "";
      els.progress.value = item.progress || "";
      els.tags.value = (item.tags || []).join(", ");
      els.rating.value = String(item.rating || 0);
      els.summary.value = item.summary || "";
      els.title.focus();
    }

    function validateForm(){
      const date = safeTrim(els.date.value);
      const title = safeTrim(els.title.value);
      const summary = safeTrim(els.summary.value);

      if(!date) return {ok:false, msg:"ë‚ ì§œë¥¼ ì…ë ¥í•´ì¤˜."};
      if(!title) return {ok:false, msg:"ì±… ì œëª©ì„ ì…ë ¥í•´ì¤˜."};
      if(!summary) return {ok:false, msg:"ê°„ë‹¨ ìš”ì•½ì„ ì…ë ¥í•´ì¤˜."};
      return {ok:true, msg:""};
    }

    function getFormData(){
      return {
        date: safeTrim(els.date.value),
        title: safeTrim(els.title.value),
        author: safeTrim(els.author.value),
        progress: safeTrim(els.progress.value),
        tags: parseTags(els.tags.value),
        rating: Number(els.rating.value) || 0,
        summary: safeTrim(els.summary.value),
      };
    }

    // ====== ë Œë” ======
    function getFilteredSortedItems(){
      const q = safeTrim(els.q.value).toLowerCase();
      const sort = els.sort.value;

      let arr = [...state.items];

      if(q){
        arr = arr.filter(it => {
          const hay = [
            it.date, it.title, it.author, it.progress,
            (it.tags || []).join(" "),
            it.summary
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      arr.sort((a,b)=>{
        const A = a.date || "";
        const B = b.date || "";
        if(sort === "old"){
          if(A === B) return (a.createdAt||0) - (b.createdAt||0);
          return A.localeCompare(B);
        }else{
          if(A === B) return (b.createdAt||0) - (a.createdAt||0);
          return B.localeCompare(A);
        }
      });

      return arr;
    }

    function render(){
      const items = getFilteredSortedItems();
      els.countLabel.textContent = `ì´ ${state.items.length}ê°œ`;

      if(items.length === 0){
        els.list.innerHTML = `<div class="empty">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ìœ„ì—ì„œ ì²« ê¸°ë¡ì„ ì €ì¥í•´ë³´ì.</div>`;
        return;
      }

      els.list.innerHTML = items.map(it => {
        const stars = formatStars(it.rating);
        const metaParts = [
          it.date ? it.date : "",
          it.author ? `ì €ì: ${escapeHtml(it.author)}` : "",
          it.progress ? `ì§„ë„: ${escapeHtml(it.progress)}` : "",
          stars ? `ë³„ì : ${stars}` : ""
        ].filter(Boolean);

        const chips = (it.tags || []).slice(0, 12).map(t => `<span class="chip">#${escapeHtml(t)}</span>`).join("");

        return `
          <article class="entry" data-id="${it.id}">
            <div class="entryTop">
              <div>
                <div class="titleLine">
                  <div class="bookTitle">${escapeHtml(it.title)}</div>
                  <div class="meta">${metaParts.join(" Â· ")}</div>
                </div>
                ${chips ? `<div class="chips">${chips}</div>` : ""}
              </div>
              <div class="entryBtns noPrint">
                <button class="smallBtn ok" data-action="edit">í¸ì§‘</button>
                <button class="smallBtn danger" data-action="del">ì‚­ì œ</button>
              </div>
            </div>
            <div class="summary">${escapeHtml(it.summary)}</div>
          </article>
        `;
      }).join("");
    }

    // ====== ë™ì‘ ======
    function upsert(){
      const v = validateForm();
      if(!v.ok){
        alert(v.msg);
        return;
      }

      const data = getFormData();

      if(state.editingId){
        const idx = state.items.findIndex(x => x.id === state.editingId);
        if(idx >= 0){
          state.items[idx] = {
            ...state.items[idx],
            ...data,
            updatedAt: nowTs(),
          };
        }
      }else{
        state.items.push({
          id: uid(),
          ...data,
          createdAt: nowTs(),
          updatedAt: nowTs(),
        });
      }

      persist();
      resetForm();
      render();
    }

    function removeById(id){
      const idx = state.items.findIndex(x => x.id === id);
      if(idx < 0) return;
      const ok = confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ?");
      if(!ok) return;

      state.items.splice(idx,1);
      persist();
      render();
    }

    function editById(id){
      const it = state.items.find(x => x.id === id);
      if(!it) return;
      fillFormForEdit(it);
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // ====== ë°±ì—…/ë³µì› ======
    function exportJson(){
      const payload = {
        app: "reading_log_simple_v1",
        exportedAt: new Date().toISOString(),
        count: state.items.length,
        items: state.items
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ë…ì„œê¸°ë¡ì¥_ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJsonFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          const incoming = obj.items ?? obj;
          if(!Array.isArray(incoming)) throw new Error("í˜•ì‹ ì˜¤ë¥˜");

          // ìµœì†Œ í•„ë“œ ë³´ì •
          const cleaned = incoming.map(x => ({
            id: x.id || uid(),
            date: safeTrim(x.date),
            title: safeTrim(x.title),
            author: safeTrim(x.author),
            progress: safeTrim(x.progress),
            tags: Array.isArray(x.tags) ? x.tags.map(t=>safeTrim(t)).filter(Boolean) : parseTags(x.tags),
            rating: Number(x.rating) || 0,
            summary: safeTrim(x.summary),
            createdAt: Number(x.createdAt) || nowTs(),
            updatedAt: Number(x.updatedAt) || nowTs(),
          })).filter(x => x.date && x.title && x.summary);

          if(cleaned.length === 0){
            alert("ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ê¸°ë¡ì´ ì—†ì–´ìš”(í•„ìˆ˜ê°’: ë‚ ì§œ/ì œëª©/ìš”ì•½).");
            return;
          }

          const ok = confirm(`ê°€ì ¸ì˜¤ê¸°: ${cleaned.length}ê°œ\nê¸°ì¡´ ê¸°ë¡ì„ ìœ ì§€í•˜ê³  í•©ì¹ ê¹Œ? (ì·¨ì†Œ=ë®ì–´ì“°ê¸°)`);
          if(ok){
            // merge: id ì¶©ëŒ ë°©ì§€
            const existingIds = new Set(state.items.map(x=>x.id));
            cleaned.forEach(x=>{
              if(existingIds.has(x.id)) x.id = uid();
              state.items.push(x);
            });
          }else{
            state.items = cleaned;
          }

          persist();
          resetForm();
          render();
          alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
        }catch(e){
          alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•´ì¤˜.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function wipeAll(){
      const ok = confirm("ì „ì²´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)");
      if(!ok) return;
      state.items = [];
      persist();
      resetForm();
      render();
    }

    // ====== ì´ë²¤íŠ¸ ======
    els.saveBtn.addEventListener("click", upsert);
    els.resetBtn.addEventListener("click", resetForm);
    els.cancelEditBtn.addEventListener("click", resetForm);

    els.q.addEventListener("input", render);
    els.sort.addEventListener("change", render);

    els.list.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;

      const action = btn.getAttribute("data-action");
      const entry = btn.closest(".entry");
      if(!entry) return;
      const id = entry.getAttribute("data-id");

      if(action === "edit") editById(id);
      if(action === "del") removeById(id);
    });

    els.exportBtn.addEventListener("click", exportJson);
    els.importBtn.addEventListener("click", () => els.importFile.click());
    els.importFile.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(file) importJsonFile(file);
      els.importFile.value = "";
    });

    els.printBtn.addEventListener("click", () => window.print());
    els.wipeBtn.addEventListener("click", wipeAll);

    // Ctrl/Cmd + Enterë¡œ ì €ì¥
    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toLowerCase().includes("mac");
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if(mod && e.key === "Enter"){
        upsert();
      }
    });

    // ====== ì‹œì‘ ======
    // ì„¤ì • ë¡œë“œ ë° ì ìš©
    const savedSettings = loadSettings();
    applyFontScale(savedSettings.fontScale);

    load();
    setDefaultDate();
    render();
  </script>
</body>
</html>

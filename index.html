<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d10" />
  <title>ë…ì„œê¸°ë¡ì¥</title>
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root{
      --bg:#0b0d10;
      --card:#12161c;
      --muted:#9aa4b2;
      --text:#e8edf3;
      --line:#243041;
      --accent:#7dd3fc;
      --danger:#fb7185;
      --ok:#86efac;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --font-scale: 1;
    }
    body{font-size: calc(14px * var(--font-scale));}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(1200px 800px at 80% 20%, rgba(134,239,172,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: rgba(125,211,252,.2);
      -webkit-touch-callout: none;
    }
    .wrap{max-width: 980px; margin: 0 auto; padding: 22px 14px 60px;}
    @media (max-width: 640px){
      .wrap{padding: 16px 12px 50px;}
    }
    header{
      display:flex; gap:12px; align-items:baseline; justify-content:space-between;
      margin: 8px 2px 14px;
    }
    @media (max-width: 640px){
      header{flex-direction: column; gap:6px; align-items:flex-start;}
    }
    h1{font-size: 22px; margin:0; letter-spacing:-0.3px}
    @media (max-width: 640px){
      h1{font-size: 20px;}
    }
    .sub{color:var(--muted); font-size: 13px}
    @media (max-width: 640px){
      .sub{font-size: 12px;}
    }
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.07);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .card h2{font-size:16px; margin: 2px 0 10px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:10px}
    @media (max-width: 520px){
      .row{grid-template-columns: 1fr}
    }
    label{display:block; font-size: 12px; color:var(--muted); margin: 0 0 6px}
    @media (max-width: 640px){
      label{font-size: 13px;}
    }
    input, textarea, select{
      width:100%;
      background: rgba(10,12,16,.6);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 11px 12px;
      outline: none;
      font-size: 16px;
      font-family: inherit;
    }
    @media (max-width: 640px){
      input, textarea, select{
        padding: 14px 12px;
        font-size: 16px;
        border-radius: 10px;
      }
    }
    textarea{min-height: 92px; resize: vertical; line-height:1.5}
    @media (max-width: 640px){
      textarea{min-height: 110px;}
    }
    input:focus, textarea:focus, select:focus{border-color: rgba(125,211,252,.55); box-shadow: 0 0 0 3px rgba(125,211,252,.12)}
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top: 10px}
    button{
      border:0;
      border-radius: 12px;
      padding: 10px 12px;
      background: rgba(125,211,252,.16);
      color: var(--text);
      cursor:pointer;
      font-weight: 650;
      font-size: 14px;
      min-height: 44px;
      font-family: inherit;
      touch-action: manipulation;
    }
    @media (max-width: 640px){
      button{
        padding: 13px 16px;
        font-size: 15px;
        min-height: 48px;
        border-radius: 10px;
      }
    }
    button:hover{filter: brightness(1.08)}
    button:active{transform: scale(0.97)}
    button.secondary{background: rgba(255,255,255,.08); font-weight: 600}
    button.danger{background: rgba(251,113,133,.18)}
    button.ok{background: rgba(134,239,172,.16)}
    .hint{color:var(--muted); font-size: 12px; margin-top: 8px; line-height:1.4}
    @media (max-width: 640px){
      .hint{font-size: 13px;}
    }
    .toolbar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin: 14px 2px;
    }
    @media (max-width: 640px){
      .toolbar{gap:8px; margin: 12px 0;}
      .toolbar .left{width:100%;}
      .toolbar .right{width:100%; justify-content:space-between;}
    }
    .toolbar .left, .toolbar .right{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      display:flex; gap:10px; align-items:center;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px 12px;
      border-radius: 999px;
    }
    .pill input{border:0; background: transparent; padding:0; width: 240px; font-size: 15px;}
    @media (max-width: 640px){
      .pill{width:100%; padding: 12px 14px;}
      .pill input{width:100%; font-size: 16px; padding: 2px 0;}
    }
    .list{
      display:grid; gap:12px;
    }
    .entry{
      border-radius: var(--radius);
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      padding: 12px 12px 10px;
    }
    @media (max-width: 640px){
      .entry{padding: 14px;}
    }
    .entryTop{
      display:flex; gap:10px; justify-content:space-between; align-items:flex-start;
    }
    @media (max-width: 640px){
      .entryTop{flex-direction: column; gap:12px;}
    }
    .titleLine{display:flex; flex-wrap:wrap; gap:8px; align-items:baseline}
    .bookTitle{font-size: 16px; font-weight: 800; letter-spacing:-.2px}
    @media (max-width: 640px){
      .bookTitle{font-size: 17px;}
    }
    .meta{color:var(--muted); font-size: 12px}
    @media (max-width: 640px){
      .meta{font-size: 13px;}
    }
    .chips{display:flex; flex-wrap:wrap; gap:6px; margin-top: 8px}
    .chip{
      font-size: 12px; color: var(--text);
      background: rgba(125,211,252,.10);
      border: 1px solid rgba(125,211,252,.18);
      padding: 5px 9px;
      border-radius: 999px;
    }
    @media (max-width: 640px){
      .chip{font-size: 13px; padding: 6px 11px;}
    }
    .summary{
      margin-top: 10px;
      color: rgba(232,237,243,.92);
      line-height: 1.55;
      white-space: pre-wrap;
      font-size: 14px;
    }
    @media (max-width: 640px){
      .summary{font-size: 15px; line-height: 1.6;}
    }
    .entryBtns{display:flex; gap:8px; flex-wrap:wrap}
    @media (max-width: 640px){
      .entryBtns{width:100%;}
    }
    .smallBtn{
      padding: 8px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 700;
      background: rgba(255,255,255,.08);
      min-height: 36px;
      font-family: inherit;
      touch-action: manipulation;
    }
    @media (max-width: 640px){
      .smallBtn{
        padding: 11px 14px;
        font-size: 14px;
        min-height: 44px;
        flex: 1;
      }
    }
    .smallBtn:hover{filter: brightness(1.08)}
    .smallBtn:active{transform: scale(0.97)}
    .smallBtn.danger{background: rgba(251,113,133,.16)}
    .smallBtn.ok{background: rgba(134,239,172,.14)}
    .divider{
      height:1px; background: rgba(255,255,255,.08); margin: 12px 0;
    }
    .footerNote{
      margin-top: 18px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.5;
    }
    @media (max-width: 640px){
      .footerNote{font-size: 13px;}
    }
    .empty{
      color: var(--muted);
      padding: 22px 10px;
      text-align:center;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
    }
    /* ëª¨ë‹¬ */
    .modal{
      display:none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show{display:flex;}
    .modalContent{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      max-width: 450px;
      width: 100%;
      padding: 24px;
      animation: modalIn .2s ease;
    }
    .modalContent.modalScrollable{
      max-height: 85vh;
      overflow-y: auto;
    }
    .modalContent.modalWide{ max-width: 520px; }
    @keyframes modalIn{
      from{opacity:0; transform: scale(0.95)}
      to{opacity:1; transform: scale(1)}
    }
    .modalHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modalHeader h3{margin:0; font-size: 18px;}
    .closeBtn{
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px 8px;
      min-height: auto;
      line-height: 1;
    }
    .closeBtn:hover{color: var(--text)}
    .settingItem{margin-bottom: 20px;}
    .settingItem label{display:block; margin-bottom: 10px; font-size: 14px; color: var(--text);}
    .scaleOptions{display:flex; gap:8px; flex-wrap:wrap;}
    .scaleBtn{
      flex: 1;
      min-width: 70px;
      background: rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.08);
      padding: 12px 8px;
      border-radius: 10px;
      font-size: 14px;
      min-height: auto;
    }
    .scaleBtn.active{
      background: rgba(125,211,252,.16);
      border-color: rgba(125,211,252,.4);
    }
    .previewText{
      margin-top: 12px;
      padding: 16px;
      background: rgba(0,0,0,.3);
      border-radius: 12px;
      color: var(--muted);
      font-size: calc(14px * var(--font-scale));
      line-height: 1.5;
    }
    .settingIcon{
      cursor: pointer;
      font-size: 20px;
      padding: 8px;
      border-radius: 8px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.08);
      transition: all .2s;
      user-select: none;
    }
    .settingIcon:hover{
      background: rgba(255,255,255,.1);
      transform: rotate(30deg);
    }
    /* íƒ­ */
    .tabs{
      display:flex;
      gap:8px;
      margin-bottom: 16px;
      border-bottom: 2px solid rgba(255,255,255,.08);
      padding-bottom: 2px;
    }
    .tabBtn{
      background: transparent;
      border: 0;
      padding: 10px 18px;
      font-size: 15px;
      font-weight: 600;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      margin-bottom: -2px;
      min-height: auto;
      transition: all .2s;
    }
    .tabBtn:hover{
      color: var(--text);
      filter: none;
    }
    .tabBtn.active{
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    .tabContent{display:none;}
    .tabContent.active{display:block;}
    /* ì •ê¸°ê°„í–‰ë¬¼ ì „ìš© */
    .magStatus{
      display: inline-flex;
      align-items: center;
      gap:6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
    }
    .magStatus.read{
      background: rgba(134,239,172,.16);
      color: var(--ok);
    }
    .magStatus.unread{
      background: rgba(255,255,255,.08);
      color: var(--muted);
    }
    .magList{display:grid; gap:10px; margin-top: 12px;}
    .magItem{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      gap:12px;
      cursor: pointer;
      transition: all .2s;
    }
    .magItem:hover{
      background: rgba(255,255,255,.06);
    }
    .magItem.read{
      background: rgba(134,239,172,.05);
      border-color: rgba(134,239,172,.15);
    }
    .magInfo{flex:1;}
    .magTitle{font-weight: 700; font-size: 14px; margin-bottom: 4px;}
    .magMeta{font-size: 12px; color: var(--muted);}
    .magActions{display:flex; gap:6px;}
    /* ê°„í–‰ë¬¼ ì´ë¦„ ê´€ë¦¬ */
    .magNameNewWrap{display:flex; gap:8px; align-items:center; margin-top: 8px;}
    .magNameNewWrap input{flex:1;}
    .magNameList{margin-top: 14px;}
    .magNameList h4{font-size: 13px; margin: 0 0 10px; color: var(--muted);}
    .magNameRow{display:flex; align-items:center; gap:8px; padding: 8px 10px; background: rgba(255,255,255,.04); border-radius: 10px; margin-bottom: 6px;}
    .magNameRow span{flex:1;}
    .magNameRow .smallBtn{padding: 6px 10px; font-size: 12px; min-height: 32px;}
    /* ë¼ì´íŠ¸ í…Œë§ˆ */
    body.theme-light{--bg:#f1f5f9;--card:#fff;--muted:#64748b;--text:#1e293b;--line:#e2e8f0;--accent:#0ea5e9;--danger:#f43f5e;--ok:#22c55e;--shadow: 0 10px 30px rgba(0,0,0,.08);}
    body.theme-light{background: linear-gradient(180deg, rgba(14,165,233,.06), transparent 40%), linear-gradient(180deg, rgba(34,197,94,.04), transparent 40%), var(--bg); color: var(--text);}
    body.theme-light .card{background: linear-gradient(180deg, rgba(255,255,255,.9), rgba(255,255,255,.95)); border-color: rgba(0,0,0,.06);}
    body.theme-light input, body.theme-light textarea, body.theme-light select{background: rgba(255,255,255,.8); color: #1e293b; border-color: rgba(0,0,0,.1);}
    body.theme-light input:focus, body.theme-light textarea:focus, body.theme-light select:focus{border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14,165,233,.15);}
    body.theme-light .pill{background: rgba(255,255,255,.7); border-color: rgba(0,0,0,.08);}
    body.theme-light .entry, body.theme-light .magItem{background: rgba(255,255,255,.5); border-color: rgba(0,0,0,.06);}
    body.theme-light .magItem.read{background: rgba(34,197,94,.08); border-color: rgba(34,197,94,.2);}
    body.theme-light .modal{background: rgba(0,0,0,.4);}
    body.theme-light .modalContent{background: #fff; border-color: rgba(0,0,0,.1); box-shadow: 0 20px 60px rgba(0,0,0,.15);}
    body.theme-light .scaleBtn, body.theme-light .themeBtn{background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.1);}
    body.theme-light .scaleBtn.active, body.theme-light .themeBtn.active{background: rgba(14,165,233,.15); border-color: rgba(14,165,233,.35);}
    body.theme-light .previewText{background: rgba(0,0,0,.05);}
    body.theme-light .closeBtn{color: var(--muted);}
    body.theme-light .magNameRow{background: rgba(0,0,0,.04);}
    .themeBtn{min-width: 80px;}
    @media print{
      body{background:#fff; color:#000}
      .card, .entry{box-shadow:none}
      .noPrint{display:none !important}
      .wrap{max-width: 900px}
      .entry{break-inside: avoid}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>ë…ì„œê¸°ë¡ì¥</h1>
        <div class="sub">ì¼ë°˜ ë„ì„œ & ì •ê¸°ê°„í–‰ë¬¼ ê´€ë¦¬</div>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <div class="sub noPrint" id="countLabel"></div>
        <span class="settingIcon noPrint" id="openSettings" title="ì„¤ì •">âš™ï¸</span>
      </div>
    </header>

    <div class="grid">
      <!-- ì…ë ¥ -->
      <section class="card noPrint" aria-label="ìƒˆ ê¸°ë¡">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
          <button class="tabBtn active" data-tab="books">ğŸ“š ì¼ë°˜ ë„ì„œ</button>
          <button class="tabBtn" data-tab="magazines">ğŸ“° ì •ê¸°ê°„í–‰ë¬¼</button>
        </div>

        <!-- ì¼ë°˜ ë„ì„œ íƒ­ -->
        <div id="booksTab" class="tabContent active">
          <h2 id="formTitle">ìƒˆ ê¸°ë¡</h2>

          <div class="row">
            <div>
              <label for="date">ë‚ ì§œ *</label>
              <input id="date" type="date" />
            </div>
            <div>
              <label for="rating">ë³„ì </label>
              <select id="rating">
                <option value="0">ì„ íƒ ì•ˆ í•¨</option>
                <option value="1">â˜…</option>
                <option value="2">â˜…â˜…</option>
                <option value="3">â˜…â˜…â˜…</option>
                <option value="4">â˜…â˜…â˜…â˜…</option>
                <option value="5">â˜…â˜…â˜…â˜…â˜…</option>
              </select>
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="title">ì±… ì œëª© *</label>
              <input id="title" type="text" placeholder="ì˜ˆ) ë°ë¯¸ì•ˆ" maxlength="80" />
            </div>
            <div>
              <label for="author">ì €ì</label>
              <input id="author" type="text" placeholder="ì˜ˆ) í—¤ë¥´ë§Œ í—¤ì„¸" maxlength="60" />
            </div>
          </div>

          <div class="row" style="margin-top:10px;">
            <div>
              <label for="progress">ì§„ë„/í˜ì´ì§€</label>
              <input id="progress" type="text" placeholder="ì˜ˆ) 1~80p / 30%" maxlength="30" />
            </div>
            <div>
              <label for="tags">íƒœê·¸(ì‰¼í‘œë¡œ êµ¬ë¶„)</label>
              <input id="tags" type="text" placeholder="ì˜ˆ) ì†Œì„¤, ì„±ì¥, ì¸ìƒ" maxlength="60" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="summary">ê°„ë‹¨ ìš”ì•½ *</label>
            <textarea id="summary" placeholder="ì§§ê²Œ: ì–´ë–¤ ë‚´ìš©ì´ì—ˆëŠ”ì§€, ê¸°ì–µí•  í¬ì¸íŠ¸ë§Œ" maxlength="600"></textarea>
          </div>

          <div class="actions">
            <button id="saveBtn" class="ok">ì €ì¥</button>
            <button id="resetBtn" class="secondary">ì´ˆê¸°í™”</button>
            <button id="cancelEditBtn" class="secondary" style="display:none;">í¸ì§‘ ì·¨ì†Œ</button>
          </div>
          <div class="hint">* ëŠ” í•„ìˆ˜. ì €ì¥í•˜ë©´ ë¸Œë¼ìš°ì €ì— ìë™ ì €ì¥ë¼ìš”.</div>
        </div>

        <!-- ì •ê¸°ê°„í–‰ë¬¼ íƒ­ -->
        <div id="magazinesTab" class="tabContent">
          <h2>ì •ê¸°ê°„í–‰ë¬¼ ê´€ë¦¬</h2>

          <div style="margin-bottom: 14px;">
            <label for="magName">ê°„í–‰ë¬¼ ì´ë¦„ *</label>
            <select id="magName" aria-label="ê°„í–‰ë¬¼ ì„ íƒ">
              <option value="">ì„ íƒ</option>
              <option value="__new__">â• ìƒˆë¡œ ì¶”ê°€</option>
            </select>
            <div id="magNameNewWrap" class="magNameNewWrap" style="display:none;">
              <input id="magNameNew" type="text" placeholder="ìƒˆ ê°„í–‰ë¬¼ ì´ë¦„" maxlength="40" />
              <button type="button" id="magNameAddBtn" class="ok">ì¶”ê°€</button>
            </div>
            <div class="hint" style="margin-top:8px;">
              <button type="button" class="smallBtn secondary" id="openMagListModal">ğŸ“‹ ê°„í–‰ë¬¼ ëª©ë¡ ê´€ë¦¬</button>
            </div>
          </div>

          <div class="row" style="margin-top:14px;">
            <div>
              <label for="magYear">ì—°ë„ *</label>
              <input id="magYear" type="number" placeholder="2026" min="1900" max="2100" />
            </div>
            <div>
              <label for="magMonth">ì›”í˜¸ *</label>
              <select id="magMonth">
                <option value="">ì„ íƒ</option>
                <option value="1">1ì›”í˜¸</option>
                <option value="2">2ì›”í˜¸</option>
                <option value="3">3ì›”í˜¸</option>
                <option value="4">4ì›”í˜¸</option>
                <option value="5">5ì›”í˜¸</option>
                <option value="6">6ì›”í˜¸</option>
                <option value="7">7ì›”í˜¸</option>
                <option value="8">8ì›”í˜¸</option>
                <option value="9">9ì›”í˜¸</option>
                <option value="10">10ì›”í˜¸</option>
                <option value="11">11ì›”í˜¸</option>
                <option value="12">12ì›”í˜¸</option>
              </select>
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="magReadDate">ì½ì€ ë‚ ì§œ (ì„ íƒ)</label>
            <input id="magReadDate" type="date" />
            <div class="hint">ì½ì§€ ì•Šì•˜ë‹¤ë©´ ë¹„ì›Œë‘ì„¸ìš”</div>
          </div>

          <div style="margin-top:10px;">
            <label for="magNotes">ë©”ëª¨ (ì„ íƒ)</label>
            <textarea id="magNotes" placeholder="ê¸°ì–µí•  ë‚´ìš©ì´ë‚˜ ì¸ìƒ ê¹Šì—ˆë˜ ë¶€ë¶„" maxlength="400"></textarea>
          </div>

          <div class="actions">
            <button id="saveMagBtn" class="ok">ì €ì¥</button>
            <button id="resetMagBtn" class="secondary">ì´ˆê¸°í™”</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="actions">
          <button type="button" class="secondary" id="openDataManageModal">ğŸ“¤ ë°ì´í„° ê´€ë¦¬</button>
        </div>
      </section>

      <!-- ëª©ë¡/ê²€ìƒ‰ -->
      <section class="card" aria-label="ê¸°ë¡ ëª©ë¡">
        <!-- íƒ­ ë©”ë‰´ -->
        <div class="tabs">
          <button class="tabBtn active" data-tab="books">ğŸ“š ì¼ë°˜ ë„ì„œ</button>
          <button class="tabBtn" data-tab="magazines">ğŸ“° ì •ê¸°ê°„í–‰ë¬¼</button>
        </div>

        <!-- ì¼ë°˜ ë„ì„œ ëª©ë¡ -->
        <div id="booksListTab" class="tabContent active">
          <h2>ê¸°ë¡</h2>

          <div class="toolbar noPrint">
            <div class="left">
              <div class="pill" title="ì œëª©/ì €ì/ìš”ì•½/íƒœê·¸ ê²€ìƒ‰">
                ğŸ” <input id="q" type="text" placeholder="ê²€ìƒ‰..." />
              </div>
            </div>
            <div class="right">
              <label class="sub" style="margin:0;">ì •ë ¬</label>
              <select id="sort" aria-label="ì •ë ¬">
                <option value="new">ìµœì‹ ìˆœ</option>
                <option value="old">ì˜¤ë˜ëœìˆœ</option>
              </select>
            </div>
          </div>

          <div id="list" class="list"></div>

          <div class="footerNote">
            íŒ: ì œëª©ì— "ì™„ë…/ì¤‘ë‹¨" ê°™ì€ ë‹¨ì–´ë¥¼ ë¶™ì´ê±°ë‚˜, íƒœê·¸ì— "ì™„ë…"ì„ ë„£ìœ¼ë©´ ì°¾ê¸° ì‰¬ì›Œìš”.
          </div>
        </div>

        <!-- ì •ê¸°ê°„í–‰ë¬¼ ëª©ë¡ -->
        <div id="magazinesListTab" class="tabContent">
          <h2>ì •ê¸°ê°„í–‰ë¬¼</h2>
          <p class="sub" style="margin: 0 0 14px;">í˜¸ìˆ˜ë³„ ì½ìŒ ê¸°ë¡ì„ ë³´ê´€í•¨ì—ì„œ í™•ì¸í•˜ì„¸ìš”.</p>
          <button type="button" class="ok" id="openMagArchiveModal" style="width:100%;">ğŸ“° ì •ê¸°ê°„í–‰ë¬¼ ë³´ê´€í•¨ ì—´ê¸°</button>
        </div>
      </section>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>âš™ï¸ ì„¤ì •</h3>
        <button class="closeBtn" id="closeSettings" aria-label="ë‹«ê¸°">&times;</button>
      </div>

      <div class="settingItem">
        <label>í…Œë§ˆ</label>
        <div class="scaleOptions">
          <button class="scaleBtn themeBtn" data-theme="dark">ğŸŒ™ ë‹¤í¬</button>
          <button class="scaleBtn themeBtn" data-theme="light">â˜€ï¸ ë¼ì´íŠ¸</button>
        </div>
      </div>

      <div class="settingItem">
        <label>í…ìŠ¤íŠ¸ í¬ê¸°</label>
        <div class="scaleOptions">
          <button class="scaleBtn" data-scale="0.85">ì‘ê²Œ</button>
          <button class="scaleBtn active" data-scale="1">ë³´í†µ</button>
          <button class="scaleBtn" data-scale="1.15">í¬ê²Œ</button>
          <button class="scaleBtn" data-scale="1.3">ì•„ì£¼ í¬ê²Œ</button>
        </div>
        <div class="previewText">
          ë¯¸ë¦¬ë³´ê¸°: ìƒˆë“¤ì€ ì•Œì—ì„œ ë‚˜ì˜¤ë ¤ê³  íˆ¬ìŸí•œë‹¤. ì•Œì€ ì„¸ê³„ì´ë‹¤. íƒœì–´ë‚˜ë ¤ëŠ” ìëŠ” í•˜ë‚˜ì˜ ì„¸ê³„ë¥¼ ê¹¨ëœ¨ë ¤ì•¼ í•œë‹¤.
        </div>
      </div>
    </div>
  </div>

  <!-- ê°„í–‰ë¬¼ ëª©ë¡ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="magListModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>ğŸ“‹ ê°„í–‰ë¬¼ ëª©ë¡ ê´€ë¦¬</h3>
        <button class="closeBtn" id="closeMagListModal" aria-label="ë‹«ê¸°">&times;</button>
      </div>

      <div class="settingItem">
        <label>ìƒˆ ê°„í–‰ë¬¼ ì¶”ê°€</label>
        <div class="magNameNewWrap">
          <input id="magNameNewModal" type="text" placeholder="ê°„í–‰ë¬¼ ì´ë¦„ ì…ë ¥" maxlength="40" />
          <button type="button" id="magNameAddModalBtn" class="ok">ì¶”ê°€</button>
        </div>
      </div>

      <div class="magNameList">
        <h4>ë“±ë¡ëœ ê°„í–‰ë¬¼</h4>
        <div id="magNameListRows"></div>
      </div>
    </div>
  </div>

  <!-- ì •ê¸°ê°„í–‰ë¬¼ ë³´ê´€í•¨ ëª¨ë‹¬ -->
  <div id="magArchiveModal" class="modal">
    <div class="modalContent modalScrollable modalWide">
      <div class="modalHeader">
        <h3>ğŸ“° ì •ê¸°ê°„í–‰ë¬¼ ë³´ê´€í•¨</h3>
        <button class="closeBtn" id="closeMagArchiveModal" aria-label="ë‹«ê¸°">&times;</button>
      </div>

      <div class="toolbar noPrint">
        <div class="left">
          <select id="magArchiveFilter" aria-label="ê°„í–‰ë¬¼ ì„ íƒ" style="width: auto; min-width: 180px;">
            <option value="">ì „ì²´ ë³´ê¸°</option>
          </select>
        </div>
        <div class="right">
          <label class="sub" style="margin:0;">ì •ë ¬</label>
          <select id="magArchiveSort" aria-label="ì •ë ¬">
            <option value="recent">ìµœì‹ í˜¸ìˆœ</option>
            <option value="oldest">ì˜¤ë˜ëœí˜¸ìˆœ</option>
          </select>
        </div>
      </div>

      <div id="magArchiveList" class="list"></div>

      <div class="footerNote">
        í•­ëª©ì„ í´ë¦­í•˜ì—¬ ì½ìŒ/ì•ˆì½ìŒì„ ì „í™˜í•  ìˆ˜ ìˆì–´ìš”. ì´ˆë¡ìƒ‰ì€ ì½ì€ í˜¸ì…ë‹ˆë‹¤.
      </div>
    </div>
  </div>

  <!-- ë°ì´í„° ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="dataManageModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>ğŸ“¤ ë°ì´í„° ê´€ë¦¬</h3>
        <button class="closeBtn" id="closeDataManageModal" aria-label="ë‹«ê¸°">&times;</button>
      </div>

      <div class="settingItem">
        <label>ë°±ì—… ë° ë³µì›</label>
        <div class="actions">
          <button id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
          <button id="importBtn" class="secondary">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
          <input id="importFile" type="file" accept="application/json" style="display:none;" />
        </div>
      </div>

      <div class="settingItem">
        <label>ì¸ì‡„ ë° ì‚­ì œ</label>
        <div class="actions">
          <button id="printBtn" class="secondary">ì¸ì‡„</button>
          <button id="wipeBtn" class="danger">ì „ì²´ ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ====== ì €ì¥ í‚¤ ======
    const STORAGE_KEY = "reading_log_simple_v1";
    const MAGAZINE_KEY = "reading_log_magazines_v1";
    const MAGAZINE_NAMES_KEY = "reading_log_magazine_names_v1";
    const SETTINGS_KEY = "reading_log_settings_v1";

    // ====== DOM ======
    const $ = (id) => document.getElementById(id);
    const els = {
      countLabel: $("countLabel"),
      formTitle: $("formTitle"),
      date: $("date"),
      title: $("title"),
      author: $("author"),
      progress: $("progress"),
      tags: $("tags"),
      rating: $("rating"),
      summary: $("summary"),
      saveBtn: $("saveBtn"),
      resetBtn: $("resetBtn"),
      cancelEditBtn: $("cancelEditBtn"),
      exportBtn: $("exportBtn"),
      importBtn: $("importBtn"),
      importFile: $("importFile"),
      printBtn: $("printBtn"),
      wipeBtn: $("wipeBtn"),
      q: $("q"),
      sort: $("sort"),
      list: $("list"),
      openSettings: $("openSettings"),
      closeSettings: $("closeSettings"),
      settingsModal: $("settingsModal"),
      // ì •ê¸°ê°„í–‰ë¬¼
      magName: $("magName"),
      magYear: $("magYear"),
      magMonth: $("magMonth"),
      magReadDate: $("magReadDate"),
      magNotes: $("magNotes"),
      saveMagBtn: $("saveMagBtn"),
      resetMagBtn: $("resetMagBtn"),
      openMagArchiveModal: $("openMagArchiveModal"),
      closeMagArchiveModal: $("closeMagArchiveModal"),
      magArchiveModal: $("magArchiveModal"),
      magArchiveFilter: $("magArchiveFilter"),
      magArchiveSort: $("magArchiveSort"),
      magArchiveList: $("magArchiveList"),
      openDataManageModal: $("openDataManageModal"),
      closeDataManageModal: $("closeDataManageModal"),
      dataManageModal: $("dataManageModal"),
      magNameNew: $("magNameNew"),
      magNameNewWrap: $("magNameNewWrap"),
      magNameAddBtn: $("magNameAddBtn"),
      magNameListRows: $("magNameListRows"),
      openMagListModal: $("openMagListModal"),
      closeMagListModal: $("closeMagListModal"),
      magListModal: $("magListModal"),
      magNameNewModal: $("magNameNewModal"),
      magNameAddModalBtn: $("magNameAddModalBtn"),
    };

    // ====== ìƒíƒœ ======
    const state = {
      items: [],
      editingId: null,
      magazines: [],
      magazineNames: [],
      currentTab: 'books'
    };

    // ====== íƒ­ ì „í™˜ ======
    function switchTab(tabName) {
      state.currentTab = tabName;
      
      // ëª¨ë“  íƒ­ ë²„íŠ¼ê³¼ ì½˜í…ì¸  ì—…ë°ì´íŠ¸
      document.querySelectorAll('.tabBtn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-tab') === tabName);
      });
      
      document.querySelectorAll('.tabContent').forEach(content => {
        content.classList.remove('active');
      });
      
      if(tabName === 'books') {
        $('booksTab').classList.add('active');
        $('booksListTab').classList.add('active');
      } else {
        $('magazinesTab').classList.add('active');
        $('magazinesListTab').classList.add('active');
        renderMagazines();
      }
    }

    document.querySelectorAll('.tabBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        switchTab(btn.getAttribute('data-tab'));
      });
    });

    // ====== ì„¤ì • ê´€ë¦¬ ======
    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        const def = { fontScale: 1, theme: 'dark' };
        if(!raw) return def;
        const o = JSON.parse(raw);
        return { fontScale: o.fontScale ?? 1, theme: o.theme ?? 'dark' };
      }catch(e){
        return { fontScale: 1, theme: 'dark' };
      }
    }

    function saveSettings(settings){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
    }

    function applyFontScale(scale){
      document.documentElement.style.setProperty('--font-scale', scale);
      document.querySelectorAll('.scaleBtn[data-scale]').forEach(btn => {
        btn.classList.toggle('active', parseFloat(btn.getAttribute('data-scale')) === scale);
      });
    }

    function applyTheme(theme){
      document.body.classList.toggle('theme-light', theme === 'light');
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', theme === 'light' ? '#f1f5f9' : '#0b0d10');
      document.querySelectorAll('.themeBtn').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-theme') === theme);
      });
    }

    els.openSettings.addEventListener('click', () => {
      els.settingsModal.classList.add('show');
    });

    els.closeSettings.addEventListener('click', () => {
      els.settingsModal.classList.remove('show');
    });

    els.settingsModal.addEventListener('click', (e) => {
      if(e.target === els.settingsModal){
        els.settingsModal.classList.remove('show');
      }
    });

    document.addEventListener('keydown', (e) => {
      if(e.key !== 'Escape') return;
      if(els.settingsModal.classList.contains('show')) els.settingsModal.classList.remove('show');
      else if(els.magListModal.classList.contains('show')) els.magListModal.classList.remove('show');
      else if(els.magArchiveModal.classList.contains('show')) els.magArchiveModal.classList.remove('show');
      else if(els.dataManageModal.classList.contains('show')) els.dataManageModal.classList.remove('show');
    });

    els.openMagListModal.addEventListener('click', () => {
      renderMagNameListRows();
      els.magListModal.classList.add('show');
      els.magNameNewModal.value = '';
      els.magNameNewModal.focus();
    });

    els.closeMagListModal.addEventListener('click', () => {
      els.magListModal.classList.remove('show');
    });

    els.magListModal.addEventListener('click', (e) => {
      if(e.target === els.magListModal) els.magListModal.classList.remove('show');
    });

    els.magNameAddModalBtn.addEventListener('click', () => {
      addMagazineName(els.magNameNewModal.value);
      els.magNameNewModal.value = '';
      els.magNameNewModal.focus();
    });

    document.querySelectorAll('.scaleBtn[data-scale]').forEach(btn => {
      btn.addEventListener('click', () => {
        const scale = parseFloat(btn.getAttribute('data-scale'));
        applyFontScale(scale);
        const settings = loadSettings();
        settings.fontScale = scale;
        saveSettings(settings);
      });
    });

    document.querySelectorAll('.themeBtn').forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-theme');
        applyTheme(theme);
        const settings = loadSettings();
        settings.theme = theme;
        saveSettings(settings);
      });
    });

    // ====== ìœ í‹¸ ======
    function uid(){
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }
    function nowTs(){ return Date.now(); }

    function safeTrim(s){ return (s ?? "").toString().trim(); }

    function parseTags(input){
      const raw = safeTrim(input);
      if(!raw) return [];
      return raw
        .split(",")
        .map(t => t.trim())
        .filter(Boolean)
        .slice(0, 12);
    }

    function formatStars(n){
      const k = Number(n) || 0;
      if(k <= 0) return "";
      return "â˜…".repeat(k);
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ====== ì¼ë°˜ ë„ì„œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ======
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        state.items = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(state.items)) state.items = [];
      }catch(e){
        state.items = [];
      }
    }

    function persist(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.items));
    }

    // ====== ì •ê¸°ê°„í–‰ë¬¼ ì´ë¦„ ë§ˆìŠ¤í„° ëª©ë¡ ======
    function loadMagazineNames(){
      try{
        const raw = localStorage.getItem(MAGAZINE_NAMES_KEY);
        state.magazineNames = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(state.magazineNames)) state.magazineNames = [];
      }catch(e){
        state.magazineNames = [];
      }
      var fromMagazines = [...new Set(state.magazines.map(m => m.name))].filter(Boolean);
      var merged = [...new Set([...state.magazineNames, ...fromMagazines])].sort();
      if(merged.length !== state.magazineNames.length || merged.some((n,i)=> n !== state.magazineNames[i])){
        state.magazineNames = merged;
        persistMagazineNames();
      }
      updateMagNameSelect();
      renderMagNameListRows();
    }

    function persistMagazineNames(){
      localStorage.setItem(MAGAZINE_NAMES_KEY, JSON.stringify(state.magazineNames));
    }

    function updateMagNameSelect(){
      const cur = els.magName.value;
      els.magName.innerHTML = '<option value="">ì„ íƒ</option>' +
        state.magazineNames.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('') +
        '<option value="__new__">â• ìƒˆë¡œ ì¶”ê°€</option>';
      if(state.magazineNames.includes(cur)) els.magName.value = cur;
      else if(cur !== '__new__') els.magName.value = '';
    }

    function renderMagNameListRows(){
      if(!state.magazineNames.length){
        els.magNameListRows.innerHTML = '<div class="hint">ë“±ë¡ëœ ê°„í–‰ë¬¼ì´ ì—†ì–´ìš”. ìœ„ì— ì´ë¦„ì„ ì…ë ¥í•˜ê³  "ì¶”ê°€"ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>';
        return;
      }
      els.magNameListRows.innerHTML = state.magazineNames.map((name, idx) => `
        <div class="magNameRow" data-idx="${idx}">
          <span>${escapeHtml(name)}</span>
          <button type="button" class="smallBtn secondary" data-action="editMagName">í¸ì§‘</button>
          <button type="button" class="smallBtn danger" data-action="delMagName">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    function addMagazineName(name){
      const n = safeTrim(name);
      if(!n){ alert('ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.'); return; }
      if(state.magazineNames.includes(n)){ alert('ì´ë¯¸ ìˆëŠ” ì´ë¦„ì´ì—ìš”.'); return; }
      state.magazineNames.push(n);
      state.magazineNames.sort();
      persistMagazineNames();
      updateMagNameSelect();
      renderMagNameListRows();
      els.magName.value = n;
      els.magNameNew.value = '';
      els.magNameNewWrap.style.display = 'none';
      updateMagFilter();
    }

    function editMagazineName(oldName, newName){
      const n = safeTrim(newName);
      if(!n){ alert('ì´ë¦„ì„ ì…ë ¥í•´ì¤˜.'); return; }
      if(n === oldName) return;
      if(state.magazineNames.includes(n)){ alert('ì´ë¯¸ ìˆëŠ” ì´ë¦„ì´ì—ìš”.'); return; }
      const idx = state.magazineNames.indexOf(oldName);
      if(idx >= 0) state.magazineNames[idx] = n;
      state.magazineNames.sort();
      state.magazines.forEach(m => { if(m.name === oldName) m.name = n; });
      persistMagazineNames();
      persistMagazines();
      updateMagNameSelect();
      renderMagNameListRows();
      updateMagFilter();
      renderMagazines();
      if(els.magName.value === oldName) els.magName.value = n;
    }

    function deleteMagazineName(name){
      const used = state.magazines.some(m => m.name === name);
      if(used){
        if(!confirm('ì´ ê°„í–‰ë¬¼ë¡œ ê¸°ë¡ëœ í˜¸ê°€ ìˆì–´ìš”. ì‚­ì œí•˜ë©´ ëª©ë¡ì—ì„œë§Œ ì‚¬ë¼ì§€ê³ , ê¸°ì¡´ ê¸°ë¡ì€ ìœ ì§€ë¼ìš”. ì‚­ì œí• ê¹Œìš”?')) return;
      }else{
        if(!confirm('"' + name + '"ì„(ë¥¼) ëª©ë¡ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) return;
      }
      state.magazineNames = state.magazineNames.filter(n => n !== name);
      persistMagazineNames();
      updateMagNameSelect();
      renderMagNameListRows();
      updateMagFilter();
      if(els.magName.value === name) els.magName.value = '';
    }

    // ====== ì •ê¸°ê°„í–‰ë¬¼ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ======
    function loadMagazines(){
      try{
        const raw = localStorage.getItem(MAGAZINE_KEY);
        state.magazines = raw ? JSON.parse(raw) : [];
        if(!Array.isArray(state.magazines)) state.magazines = [];
      }catch(e){
        state.magazines = [];
      }
      loadMagazineNames();
      updateMagFilter();
    }

    function persistMagazines(){
      localStorage.setItem(MAGAZINE_KEY, JSON.stringify(state.magazines));
    }

    function updateMagFilter(){
      const names = state.magazineNames.length ? state.magazineNames : [...new Set(state.magazines.map(m => m.name))].sort();
      if(els.magArchiveFilter){
        const cur = els.magArchiveFilter.value;
        els.magArchiveFilter.innerHTML = '<option value="">ì „ì²´ ë³´ê¸°</option>' + 
          names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
        if(names.includes(cur)) els.magArchiveFilter.value = cur;
      }
    }

    // ====== ì¼ë°˜ ë„ì„œ í¼ ======
    function setDefaultDate(){
      if(!els.date.value){
        const d = new Date();
        const yyyy = d.getFullYear();
        const mm = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        els.date.value = `${yyyy}-${mm}-${dd}`;
      }
    }

    function resetForm(){
      state.editingId = null;
      els.formTitle.textContent = "ìƒˆ ê¸°ë¡";
      els.saveBtn.textContent = "ì €ì¥";
      els.cancelEditBtn.style.display = "none";

      els.title.value = "";
      els.author.value = "";
      els.progress.value = "";
      els.tags.value = "";
      els.rating.value = "0";
      els.summary.value = "";
      els.date.value = "";
      setDefaultDate();
      els.title.focus();
    }

    function fillFormForEdit(item){
      state.editingId = item.id;
      els.formTitle.textContent = "ê¸°ë¡ í¸ì§‘";
      els.saveBtn.textContent = "ìˆ˜ì • ì €ì¥";
      els.cancelEditBtn.style.display = "inline-block";

      els.date.value = item.date || "";
      els.title.value = item.title || "";
      els.author.value = item.author || "";
      els.progress.value = item.progress || "";
      els.tags.value = (item.tags || []).join(", ");
      els.rating.value = String(item.rating || 0);
      els.summary.value = item.summary || "";
      els.title.focus();
    }

    function validateForm(){
      const date = safeTrim(els.date.value);
      const title = safeTrim(els.title.value);
      const summary = safeTrim(els.summary.value);

      if(!date) return {ok:false, msg:"ë‚ ì§œë¥¼ ì…ë ¥í•´ì¤˜."};
      if(!title) return {ok:false, msg:"ì±… ì œëª©ì„ ì…ë ¥í•´ì¤˜."};
      if(!summary) return {ok:false, msg:"ê°„ë‹¨ ìš”ì•½ì„ ì…ë ¥í•´ì¤˜."};
      return {ok:true, msg:""};
    }

    function getFormData(){
      return {
        date: safeTrim(els.date.value),
        title: safeTrim(els.title.value),
        author: safeTrim(els.author.value),
        progress: safeTrim(els.progress.value),
        tags: parseTags(els.tags.value),
        rating: Number(els.rating.value) || 0,
        summary: safeTrim(els.summary.value),
      };
    }

    // ====== ì •ê¸°ê°„í–‰ë¬¼ í¼ ======
    function setDefaultMagYear(){
      if(!els.magYear.value){
        els.magYear.value = new Date().getFullYear();
      }
    }

    function resetMagForm(){
      els.magName.value = "";
      els.magNameNew.value = "";
      els.magNameNewWrap.style.display = "none";
      els.magYear.value = "";
      els.magMonth.value = "";
      els.magReadDate.value = "";
      els.magNotes.value = "";
      setDefaultMagYear();
      els.magName.focus();
    }

    function getSelectedMagName(){
      if(els.magName.value === "__new__") return safeTrim(els.magNameNew.value);
      return safeTrim(els.magName.value);
    }

    function validateMagForm(){
      const name = getSelectedMagName();
      const year = safeTrim(els.magYear.value);
      const month = safeTrim(els.magMonth.value);

      if(!name) return {ok:false, msg:"ê°„í–‰ë¬¼ì„ ì„ íƒí•˜ê±°ë‚˜ ìƒˆë¡œ ì¶”ê°€í•´ì¤˜."};
      if(!year) return {ok:false, msg:"ì—°ë„ë¥¼ ì…ë ¥í•´ì¤˜."};
      if(!month) return {ok:false, msg:"ì›”í˜¸ë¥¼ ì„ íƒí•´ì¤˜."};
      return {ok:true, msg:""};
    }

    function getMagFormData(){
      var name = getSelectedMagName();
      if(els.magName.value === "__new__" && name && !state.magazineNames.includes(name)){
        addMagazineName(name);
      }
      return {
        name: name,
        year: Number(els.magYear.value),
        month: Number(els.magMonth.value),
        readDate: safeTrim(els.magReadDate.value) || null,
        notes: safeTrim(els.magNotes.value),
        isRead: !!safeTrim(els.magReadDate.value)
      };
    }

    // ====== ì¼ë°˜ ë„ì„œ ë Œë” ======
    function getFilteredSortedItems(){
      const q = safeTrim(els.q.value).toLowerCase();
      const sort = els.sort.value;

      let arr = [...state.items];

      if(q){
        arr = arr.filter(it => {
          const hay = [
            it.date, it.title, it.author, it.progress,
            (it.tags || []).join(" "),
            it.summary
          ].join(" ").toLowerCase();
          return hay.includes(q);
        });
      }

      arr.sort((a,b)=>{
        const A = a.date || "";
        const B = b.date || "";
        if(sort === "old"){
          if(A === B) return (a.createdAt||0) - (b.createdAt||0);
          return A.localeCompare(B);
        }else{
          if(A === B) return (b.createdAt||0) - (a.createdAt||0);
          return B.localeCompare(A);
        }
      });

      return arr;
    }

    function render(){
      const items = getFilteredSortedItems();
      els.countLabel.textContent = `ë„ì„œ ${state.items.length}ê°œ Â· ê°„í–‰ë¬¼ ${state.magazines.length}ê°œ`;

      if(items.length === 0){
        els.list.innerHTML = `<div class="empty">ì•„ì§ ê¸°ë¡ì´ ì—†ì–´ìš”. ìœ„ì—ì„œ ì²« ê¸°ë¡ì„ ì €ì¥í•´ë³´ì.</div>`;
        return;
      }

      els.list.innerHTML = items.map(it => {
        const stars = formatStars(it.rating);
        const metaParts = [
          it.date ? it.date : "",
          it.author ? `ì €ì: ${escapeHtml(it.author)}` : "",
          it.progress ? `ì§„ë„: ${escapeHtml(it.progress)}` : "",
          stars ? `ë³„ì : ${stars}` : ""
        ].filter(Boolean);

        const chips = (it.tags || []).slice(0, 12).map(t => `<span class="chip">#${escapeHtml(t)}</span>`).join("");

        return `
          <article class="entry" data-id="${it.id}">
            <div class="entryTop">
              <div>
                <div class="titleLine">
                  <div class="bookTitle">${escapeHtml(it.title)}</div>
                  <div class="meta">${metaParts.join(" Â· ")}</div>
                </div>
                ${chips ? `<div class="chips">${chips}</div>` : ""}
              </div>
              <div class="entryBtns noPrint">
                <button class="smallBtn ok" data-action="edit">í¸ì§‘</button>
                <button class="smallBtn danger" data-action="del">ì‚­ì œ</button>
              </div>
            </div>
            <div class="summary">${escapeHtml(it.summary)}</div>
          </article>
        `;
      }).join("");
    }

    // ====== ì •ê¸°ê°„í–‰ë¬¼ ë Œë” ======
    function getFilteredSortedMagazines(){
      const filterEl = els.magArchiveFilter;
      const sortEl = els.magArchiveSort;
      const filterName = filterEl ? filterEl.value : '';
      const sort = sortEl ? sortEl.value : 'recent';

      let arr = [...state.magazines];

      if(filterName){
        arr = arr.filter(m => m.name === filterName);
      }

      arr.sort((a,b)=>{
        const A = a.year * 100 + a.month;
        const B = b.year * 100 + b.month;
        return sort === 'oldest' ? A - B : B - A;
      });

      return arr;
    }

    function renderMagazines(){
      const items = getFilteredSortedMagazines();
      const container = els.magArchiveList;
      if(!container) return;

      if(items.length === 0){
        container.innerHTML = `<div class="empty">ë“±ë¡ëœ ì •ê¸°ê°„í–‰ë¬¼ì´ ì—†ì–´ìš”. ìœ„ì—ì„œ ì¶”ê°€í•´ë³´ì„¸ìš”!</div>`;
        return;
      }

      container.innerHTML = items.map(m => {
        const readClass = m.isRead ? 'read' : 'unread';
        const readMark = m.isRead ? 'âœ“' : '';
        const readInfo = m.readDate ? `ì½ìŒ: ${m.readDate}` : 'ë¯¸ë…';
        
        return `
          <div class="magItem ${readClass}" data-id="${m.id}">
            <div class="magInfo">
              <div class="magTitle">${readMark} ${escapeHtml(m.name)} ${m.year}ë…„ ${m.month}ì›”í˜¸</div>
              <div class="magMeta">${readInfo}${m.notes ? ' Â· ' + escapeHtml(m.notes.substring(0,50)) : ''}</div>
            </div>
            <div class="magActions noPrint">
              <button class="smallBtn danger" data-action="delMag">ì‚­ì œ</button>
            </div>
          </div>
        `;
      }).join("");
    }

    // ====== ì¼ë°˜ ë„ì„œ ë™ì‘ ======
    function upsert(){
      const v = validateForm();
      if(!v.ok){
        alert(v.msg);
        return;
      }

      const data = getFormData();

      if(state.editingId){
        const idx = state.items.findIndex(x => x.id === state.editingId);
        if(idx >= 0){
          state.items[idx] = {
            ...state.items[idx],
            ...data,
            updatedAt: nowTs(),
          };
        }
      }else{
        state.items.push({
          id: uid(),
          ...data,
          createdAt: nowTs(),
          updatedAt: nowTs(),
        });
      }

      persist();
      resetForm();
      render();
    }

    function removeById(id){
      const idx = state.items.findIndex(x => x.id === id);
      if(idx < 0) return;
      const ok = confirm("ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ?");
      if(!ok) return;

      state.items.splice(idx,1);
      persist();
      render();
    }

    function editById(id){
      const it = state.items.find(x => x.id === id);
      if(!it) return;
      fillFormForEdit(it);
      window.scrollTo({top:0, behavior:"smooth"});
    }

    // ====== ì •ê¸°ê°„í–‰ë¬¼ ë™ì‘ ======
    function saveMagazine(){
      const v = validateMagForm();
      if(!v.ok){
        alert(v.msg);
        return;
      }

      const data = getMagFormData();
      
      // ì¤‘ë³µ ì²´í¬
      const existing = state.magazines.find(m => 
        m.name === data.name && m.year === data.year && m.month === data.month
      );

      if(existing){
        const ok = confirm("ì´ë¯¸ ê°™ì€ í˜¸ê°€ ë“±ë¡ë˜ì–´ ìˆì–´ìš”. ë®ì–´ì“¸ê¹Œìš”?");
        if(!ok) return;
        existing.readDate = data.readDate;
        existing.notes = data.notes;
        existing.isRead = data.isRead;
        existing.updatedAt = nowTs();
      }else{
        state.magazines.push({
          id: uid(),
          ...data,
          createdAt: nowTs(),
          updatedAt: nowTs(),
        });
      }

      persistMagazines();
      resetMagForm();
      updateMagNameSelect();
      renderMagNameListRows();
      updateMagFilter();
      renderMagazines();
      render();
    }

    function toggleMagRead(id){
      const mag = state.magazines.find(m => m.id === id);
      if(!mag) return;

      if(mag.isRead){
        mag.isRead = false;
        mag.readDate = null;
      }else{
        mag.isRead = true;
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,"0");
        const dd = String(today.getDate()).padStart(2,"0");
        mag.readDate = `${yyyy}-${mm}-${dd}`;
      }

      mag.updatedAt = nowTs();
      persistMagazines();
      renderMagazines();
    }

    function removeMagById(id){
      const idx = state.magazines.findIndex(m => m.id === id);
      if(idx < 0) return;
      const ok = confirm("ì´ ê°„í–‰ë¬¼ì„ ì‚­ì œí• ê¹Œ?");
      if(!ok) return;

      state.magazines.splice(idx,1);
      persistMagazines();
      updateMagNamesList();
      updateMagFilter();
      renderMagazines();
      render(); // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
    }

    // ====== ë°±ì—…/ë³µì› ======
    function exportJson(){
      const payload = {
        app: "reading_log_simple_v1",
        exportedAt: new Date().toISOString(),
        books: state.items,
        magazines: state.magazines,
        magazineNames: state.magazineNames
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ë…ì„œê¸°ë¡ì¥_ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJsonFile(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          
          const incomingBooks = obj.books || obj.items || [];
          const incomingMags = obj.magazines || [];

          if(!Array.isArray(incomingBooks) && !Array.isArray(incomingMags)){
            throw new Error("í˜•ì‹ ì˜¤ë¥˜");
          }

          const incomingNames = Array.isArray(obj.magazineNames) ? obj.magazineNames : [];
          const ok = confirm(`ê°€ì ¸ì˜¤ê¸°: ë„ì„œ ${incomingBooks.length}ê°œ, ê°„í–‰ë¬¼ ${incomingMags.length}ê°œ\nê¸°ì¡´ ê¸°ë¡ì„ ìœ ì§€í•˜ê³  í•©ì¹ ê¹Œ? (ì·¨ì†Œ=ë®ì–´ì“°ê¸°)`);
          
          if(ok){
            // ë„ì„œ ë³‘í•©
            const existingIds = new Set(state.items.map(x=>x.id));
            incomingBooks.forEach(x=>{
              if(existingIds.has(x.id)) x.id = uid();
              state.items.push(x);
            });

            // ì •ê¸°ê°„í–‰ë¬¼ ë³‘í•©
            const existingMagIds = new Set(state.magazines.map(x=>x.id));
            incomingMags.forEach(x=>{
              if(existingMagIds.has(x.id)) x.id = uid();
              state.magazines.push(x);
            });

            state.magazineNames = [...new Set([...state.magazineNames, ...incomingNames])].sort();
          }else{
            state.items = incomingBooks;
            state.magazines = incomingMags;
            state.magazineNames = incomingNames.length ? incomingNames : [...new Set(incomingMags.map(m=>m.name))].filter(Boolean).sort();
          }

          persist();
          persistMagazines();
          persistMagazineNames();
          resetForm();
          resetMagForm();
          loadMagazineNames();
          updateMagFilter();
          render();
          renderMagazines();
          alert("ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!");
        }catch(e){
          alert("ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•´ì¤˜.");
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function wipeAll(){
      const ok = confirm("ì „ì²´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œ? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŒ)");
      if(!ok) return;
      state.items = [];
      state.magazines = [];
      state.magazineNames = [];
      persist();
      persistMagazines();
      persistMagazineNames();
      resetForm();
      resetMagForm();
      updateMagNameSelect();
      renderMagNameListRows();
      updateMagFilter();
      render();
      renderMagazines();
    }

    // ====== ì´ë²¤íŠ¸ ======
    els.saveBtn.addEventListener("click", upsert);
    els.resetBtn.addEventListener("click", resetForm);
    els.cancelEditBtn.addEventListener("click", resetForm);

    els.saveMagBtn.addEventListener("click", saveMagazine);
    els.resetMagBtn.addEventListener("click", resetMagForm);

    els.magName.addEventListener("change", () => {
      els.magNameNewWrap.style.display = els.magName.value === "__new__" ? "flex" : "none";
      if(els.magName.value === "__new__") els.magNameNew.focus();
    });

    els.magNameAddBtn.addEventListener("click", () => {
      addMagazineName(els.magNameNew.value);
    });

    els.magNameListRows.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      const row = e.target.closest(".magNameRow");
      if(!btn || !row) return;
      const idx = parseInt(row.getAttribute("data-idx"), 10);
      if(isNaN(idx) || idx < 0 || idx >= state.magazineNames.length) return;
      const name = state.magazineNames[idx];
      const action = btn.getAttribute("data-action");
      if(action === "editMagName"){
        const newName = prompt("ìƒˆ ì´ë¦„", name);
        if(newName != null) editMagazineName(name, newName);
      }else if(action === "delMagName"){
        deleteMagazineName(name);
      }
    });

    els.q.addEventListener("input", render);
    els.sort.addEventListener("change", render);

    if(els.magArchiveFilter) els.magArchiveFilter.addEventListener("change", renderMagazines);
    if(els.magArchiveSort) els.magArchiveSort.addEventListener("change", renderMagazines);

    els.openMagArchiveModal.addEventListener("click", () => {
      updateMagFilter();
      renderMagazines();
      els.magArchiveModal.classList.add("show");
    });

    els.closeMagArchiveModal.addEventListener("click", () => {
      els.magArchiveModal.classList.remove("show");
    });

    els.magArchiveModal.addEventListener("click", (e) => {
      if(e.target === els.magArchiveModal) els.magArchiveModal.classList.remove("show");
    });

    els.openDataManageModal.addEventListener("click", () => {
      els.dataManageModal.classList.add("show");
    });

    els.closeDataManageModal.addEventListener("click", () => {
      els.dataManageModal.classList.remove("show");
    });

    els.dataManageModal.addEventListener("click", (e) => {
      if(e.target === els.dataManageModal) els.dataManageModal.classList.remove("show");
    });

    els.list.addEventListener("click", (e) => {
      const btn = e.target.closest("button");
      if(!btn) return;

      const action = btn.getAttribute("data-action");
      const entry = btn.closest(".entry");
      if(!entry) return;
      const id = entry.getAttribute("data-id");

      if(action === "edit") editById(id);
      if(action === "del") removeById(id);
    });

    function handleMagItemClick(e){
      const btn = e.target.closest("button");
      const item = e.target.closest(".magItem");
      if(!item) return;
      const id = item.getAttribute("data-id");
      if(btn){
        const action = btn.getAttribute("data-action");
        if(action === "delMag"){
          e.stopPropagation();
          removeMagById(id);
        }
      }else{
        toggleMagRead(id);
      }
    }

    if(els.magArchiveList) els.magArchiveList.addEventListener("click", handleMagItemClick);

    els.exportBtn.addEventListener("click", exportJson);
    els.importBtn.addEventListener("click", () => els.importFile.click());
    els.importFile.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if(file) importJsonFile(file);
      els.importFile.value = "";
    });

    els.printBtn.addEventListener("click", () => window.print());
    els.wipeBtn.addEventListener("click", wipeAll);

    // Ctrl/Cmd + Enterë¡œ ì €ì¥
    document.addEventListener("keydown", (e) => {
      const isMac = navigator.platform.toLowerCase().includes("mac");
      const mod = isMac ? e.metaKey : e.ctrlKey;
      if(mod && e.key === "Enter"){
        if(state.currentTab === 'books'){
          upsert();
        }else{
          saveMagazine();
        }
      }
    });

    // ====== ì‹œì‘ ======
    const savedSettings = loadSettings();
    applyFontScale(savedSettings.fontScale);
    applyTheme(savedSettings.theme);

    load();
    loadMagazines();
    setDefaultDate();
    setDefaultMagYear();
    render();
    renderMagazines();

    // PWA: Service Worker ë“±ë¡ (Chrome ì„¤ì¹˜ìš©)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function () {
        navigator.serviceWorker.register('./sw.js', { scope: './' })
          .then(function (reg) { console.log('SW ë“±ë¡ë¨:', reg.scope); })
          .catch(function (err) { console.warn('SW ë“±ë¡ ì‹¤íŒ¨:', err); });
      });
    }
  </script>
</body>
</html>

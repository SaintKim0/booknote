<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5, user-scalable=yes" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#0b0d10" />
  <title>ì •ê¸°ê°„í–‰ë¬¼ ì²´í¬ v1.1</title>
  <link rel="manifest" href="./manifest.json" />
  <!-- ë²„ì „: 2026-02-10 09:14 - ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ ì¶”ê°€ -->
  <style>
    :root{
      --bg:#0b0d10;
      --muted:#9aa4b2;
      --text:#e8edf3;
      --accent:#7dd3fc;
      --danger:#fb7185;
      --ok:#86efac;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --font-scale: 1;
    }
    body{font-size: calc(15px * var(--font-scale));}
    *{box-sizing:border-box; margin:0; padding:0;}
    body{
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", sans-serif;
      background: radial-gradient(1200px 800px at 20% 0%, rgba(125,211,252,.10), transparent 60%),
                  radial-gradient(1200px 800px at 80% 20%, rgba(134,239,172,.08), transparent 55%),
                  var(--bg);
      color:var(--text);
      -webkit-tap-highlight-color: rgba(125,211,252,.2);
    }
    .wrap{max-width: 600px; margin: 0 auto; padding: 20px 16px 60px;}
    header{text-align: center; margin: 12px 0 24px;}
    h1{font-size: 24px; letter-spacing:-0.5px; margin-bottom: 6px;}
    .sub{color:var(--muted); font-size: 14px;}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin-bottom: 16px;
    }
    .row{display:flex; gap:12px; margin-bottom: 16px;}
    .row > div{flex:1;}
    label{display:block; font-size: 13px; color:var(--muted); margin-bottom: 8px;}
    input, select{
      width:100%;
      background: rgba(10,12,16,.6);
      color: var(--text);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 10px;
      padding: 12px;
      outline: none;
      font-size: 16px;
      font-family: inherit;
    }
    input:focus, select:focus{border-color: var(--accent); box-shadow: 0 0 0 3px rgba(125,211,252,.12);}
    button{
      border:0;
      border-radius: 10px;
      padding: 12px 16px;
      background: rgba(125,211,252,.16);
      color: var(--text);
      cursor:pointer;
      font-weight: 650;
      font-size: 15px;
      min-height: 48px;
      font-family: inherit;
      touch-action: manipulation;
      width: 100%;
    }
    button:hover{filter: brightness(1.08);}
    button:active{transform: scale(0.98);}
    button.secondary{background: rgba(255,255,255,.08);}
    button.danger{background: rgba(251,113,133,.18);}
    button.ok{background: rgba(134,239,172,.16);}
    button.small{padding: 10px 14px; font-size: 14px; min-height: 42px; width: auto;}
    .magList{display:grid; gap:10px; margin-top: 14px;}
    .magItem{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      gap:12px;
      transition: all .2s;
    }
    .magItem.read{
      background: rgba(134,239,172,.06);
      border-color: rgba(134,239,172,.18);
    }
    .magInfo{flex:1;}
    .magTitle{font-weight: 700; font-size: 16px; margin-bottom: 4px;}
    .magMeta{font-size: 13px; color: var(--muted);}
    .actions{display:flex; gap:8px;}
    .hint{color:var(--muted); font-size: 13px; margin-top: 10px; line-height:1.4;}
    .empty{
      color: var(--muted);
      padding: 30px 16px;
      text-align:center;
      border: 1px dashed rgba(255,255,255,.14);
      border-radius: var(--radius);
      background: rgba(255,255,255,.02);
      font-size: 14px;
    }
    .settingIcon{
      position: fixed;
      top: 16px;
      right: 16px;
      cursor: pointer;
      font-size: 24px;
      padding: 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      transition: all .2s;
      z-index: 100;
    }
    .settingIcon:hover{background: rgba(255,255,255,.12); transform: rotate(30deg);}
    .modal{
      display:none;
      position: fixed;
      inset: 0;
      z-index: 1000;
      background: rgba(0,0,0,.75);
      backdrop-filter: blur(4px);
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .modal.show{display:flex;}
    .modalContent{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
      max-width: 480px;
      width: 100%;
      padding: 24px;
      max-height: 85vh;
      overflow-y: auto;
    }
    .modalHeader{display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;}
    .modalHeader h3{font-size: 18px;}
    .closeBtn{
      background: transparent;
      border: 0;
      color: var(--muted);
      font-size: 28px;
      cursor: pointer;
      padding: 4px;
      min-height: auto;
      line-height: 1;
      width: auto;
    }
    .closeBtn:hover{color: var(--text);}
    .settingItem{margin-bottom: 20px;}
    .settingItem label{font-size: 14px; color: var(--text); margin-bottom: 10px;}
    .nameList{margin-top: 10px;}
    .nameRow{
      display:flex;
      align-items:center;
      gap:8px;
      padding: 10px 12px;
      background: rgba(255,255,255,.04);
      border-radius: 10px;
      margin-bottom: 8px;
    }
    .nameRow span{flex:1; font-size: 15px;}
    .themeOptions{display:flex; gap:8px;}
    .themeBtn{
      flex:1;
      background: rgba(255,255,255,.06);
      border: 2px solid rgba(255,255,255,.08);
      padding: 12px;
      border-radius: 10px;
      font-size: 15px;
      min-height: auto;
    }
    .themeBtn.active{background: rgba(125,211,252,.16); border-color: rgba(125,211,252,.4);}
    /* ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ */
    .dateModalContent{max-width: 360px;}
    .dateInput{
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border-radius: 10px;
      cursor: pointer;
      color-scheme: dark;
    }
    .dateInput::-webkit-calendar-picker-indicator{
      cursor: pointer;
      filter: invert(1);
      font-size: 20px;
      padding: 4px;
    }
    .modalActions{
      display: flex;
      gap: 12px;
      padding: 0 0 4px 0;
      margin-top: 20px;
    }
    .btnFlex{flex: 1;}
    /* ë¼ì´íŠ¸ í…Œë§ˆ */
    body.theme-light{--bg:#f1f5f9;--muted:#64748b;--text:#1e293b;--accent:#0ea5e9;--danger:#f43f5e;--ok:#22c55e;--shadow: 0 10px 30px rgba(0,0,0,.08);}
    body.theme-light{background: linear-gradient(180deg, rgba(14,165,233,.06), transparent 40%), linear-gradient(180deg, rgba(34,197,94,.04), transparent 40%), var(--bg);}
    body.theme-light .card{background: rgba(255,255,255,.95); border-color: rgba(0,0,0,.08);}
    body.theme-light input, body.theme-light select{background: rgba(255,255,255,.9); color: #1e293b; border-color: rgba(0,0,0,.12);}
    body.theme-light input:focus, body.theme-light select:focus{border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14,165,233,.15);}
    body.theme-light .magItem{background: rgba(255,255,255,.6); border-color: rgba(0,0,0,.08);}
    body.theme-light .magItem.read{background: rgba(34,197,94,.10); border-color: rgba(34,197,94,.25);}
    body.theme-light .modal{background: rgba(0,0,0,.4);}
    body.theme-light .modalContent{background: #fff; border-color: rgba(0,0,0,.12); box-shadow: 0 20px 60px rgba(0,0,0,.2);}
    body.theme-light .nameRow{background: rgba(0,0,0,.04);}
    body.theme-light .themeBtn{background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.1);}
    body.theme-light .themeBtn.active{background: rgba(14,165,233,.15); border-color: rgba(14,165,233,.35);}
    body.theme-light .settingIcon{background: rgba(0,0,0,.06); border-color: rgba(0,0,0,.1);}
    body.theme-light .dateInput{color-scheme: light;}
    body.theme-light .dateInput::-webkit-calendar-picker-indicator{filter: invert(0);}
  </style>
</head>
<body>
  <span class="settingIcon" id="openSettings" title="ì„¤ì •">âš™ï¸</span>

  <div class="wrap">
    <header>
      <h1>ğŸ“° ì •ê¸°ê°„í–‰ë¬¼ ì²´í¬</h1>
      <div class="sub">ë§¤ì›” ì½ìŒ ê¸°ë¡</div>
    </header>

    <div class="card">
      <div class="row">
        <div>
          <label for="year">ì—°ë„</label>
          <input id="year" type="number" placeholder="2026" min="2000" max="2100" />
        </div>
        <div>
          <label for="month">ì›”</label>
          <select id="month">
            <option value="1">1ì›”</option>
            <option value="2">2ì›”</option>
            <option value="3">3ì›”</option>
            <option value="4">4ì›”</option>
            <option value="5">5ì›”</option>
            <option value="6">6ì›”</option>
            <option value="7">7ì›”</option>
            <option value="8">8ì›”</option>
            <option value="9">9ì›”</option>
            <option value="10">10ì›”</option>
            <option value="11">11ì›”</option>
            <option value="12">12ì›”</option>
          </select>
        </div>
      </div>

      <div>
        <button type="button" class="secondary small" id="openNamesModal" style="width:auto;">ğŸ“‹ ê°„í–‰ë¬¼ ê´€ë¦¬</button>
        <button type="button" class="secondary small" id="openArchiveModal" style="width:auto;">ğŸ“š ë³´ê´€í•¨</button>
        <button type="button" class="secondary small" id="openDataModal" style="width:auto;">ğŸ’¾ ë°ì´í„°</button>
      </div>

      <div class="magList" id="checklist"></div>

      <div class="hint" id="countLabel"></div>
    </div>
  </div>

  <!-- ê°„í–‰ë¬¼ ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="namesModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>ğŸ“‹ ê°„í–‰ë¬¼ ê´€ë¦¬</h3>
        <button class="closeBtn" id="closeNames">&times;</button>
      </div>

      <div class="settingItem">
        <label>ìƒˆ ê°„í–‰ë¬¼ ì¶”ê°€</label>
        <div class="row">
          <div>
            <input id="newName" type="text" placeholder="ì˜ˆ) ë‰´íŠ¼, ê³¼í•™ë™ì•„" maxlength="40" />
          </div>
          <div style="flex:0 0 auto;">
            <button type="button" class="ok" id="addNameBtn">ì¶”ê°€</button>
          </div>
        </div>
      </div>

      <div class="settingItem">
        <label>ë“±ë¡ëœ ê°„í–‰ë¬¼</label>
        <div class="nameList" id="nameList"></div>
      </div>
    </div>
  </div>

  <!-- ë³´ê´€í•¨ ëª¨ë‹¬ -->
  <div id="archiveModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>ğŸ“š ë³´ê´€í•¨</h3>
        <button class="closeBtn" id="closeArchive">&times;</button>
      </div>

      <div style="margin-bottom: 16px;">
        <label for="archiveFilter">ê°„í–‰ë¬¼</label>
        <select id="archiveFilter">
          <option value="">ì „ì²´ ë³´ê¸°</option>
        </select>
      </div>

      <div class="magList" id="archiveList"></div>
    </div>
  </div>

  <!-- ë°ì´í„° ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="dataModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>ğŸ’¾ ë°ì´í„° ê´€ë¦¬</h3>
        <button class="closeBtn" id="closeData">&times;</button>
      </div>

      <div class="settingItem">
        <label>ë°±ì—… ë° ë³µì›</label>
        <button id="exportBtn">ë‚´ë³´ë‚´ê¸°(JSON)</button>
        <button id="importBtn" class="secondary" style="margin-top:8px;">ê°€ì ¸ì˜¤ê¸°(JSON)</button>
        <input id="importFile" type="file" accept="application/json" style="display:none;" />
      </div>

      <div class="settingItem">
        <label>ì „ì²´ ì‚­ì œ</label>
        <button id="wipeBtn" class="danger">ëª¨ë“  ê¸°ë¡ ì‚­ì œ</button>
      </div>
    </div>
  </div>

  <!-- ì„¤ì • ëª¨ë‹¬ -->
  <div id="settingsModal" class="modal">
    <div class="modalContent">
      <div class="modalHeader">
        <h3>âš™ï¸ ì„¤ì •</h3>
        <button class="closeBtn" id="closeSettings">&times;</button>
      </div>

      <div class="settingItem">
        <label>í…Œë§ˆ</label>
        <div class="themeOptions">
          <button class="themeBtn" data-theme="dark">ğŸŒ™ ë‹¤í¬</button>
          <button class="themeBtn active" data-theme="light">â˜€ï¸ ë¼ì´íŠ¸</button>
        </div>
      </div>

      <div class="settingItem">
        <label>í…ìŠ¤íŠ¸ í¬ê¸°</label>
        <div class="themeOptions">
          <button class="themeBtn" data-scale="0.85">ì‘ê²Œ</button>
          <button class="themeBtn active" data-scale="1">ë³´í†µ</button>
          <button class="themeBtn" data-scale="1.15">í¬ê²Œ</button>
          <button class="themeBtn" data-scale="1.3">ì•„ì£¼ í¬ê²Œ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ì½ì€ ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ -->
  <div id="dateModal" class="modal">
    <div class="modalContent dateModalContent">
      <div class="modalHeader">
        <h3>ğŸ“… ì½ì€ ë‚ ì§œ ì„ íƒ</h3>
        <button class="closeBtn" id="closeDateModal">&times;</button>
      </div>
      <div class="settingItem">
        <label>ì½ì€ ë‚ ì§œ</label>
        <input type="date" id="readDateInput" class="dateInput">
      </div>
      <div class="modalActions">
        <button id="dateConfirm" class="ok btnFlex">í™•ì¸</button>
        <button id="dateCancel" class="secondary btnFlex">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <script>
    // ====== ë²„ì „ v1.2 - Service Worker ìºì‹œ ì œê±° (2026-02-10 09:20) ======
    console.clear();
    console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: #7dd3fc');
    console.log('%cğŸ“… ì •ê¸°ê°„í–‰ë¬¼ ì²´í¬ v1.2', 'color: #7dd3fc; font-size: 24px; font-weight: bold');
    console.log('%câ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'color: #7dd3fc');
    console.log('ğŸ• ë¡œë“œ ì‹œê°:', new Date().toLocaleString('ko-KR'));
    console.log('ğŸ”„ Service Worker ìºì‹œ ì œê±°ë¨');
    
    // ====== ì €ì¥ í‚¤ ======
    const STORAGE_KEY = "mag_checklist_v1";
    const SETTINGS_KEY = "mag_settings_v1";

    // ====== DOM ======
    const $ = (id) => document.getElementById(id);
    const els = {
      year: $("year"),
      month: $("month"),
      checklist: $("checklist"),
      countLabel: $("countLabel"),
      openNamesModal: $("openNamesModal"),
      closeNames: $("closeNames"),
      namesModal: $("namesModal"),
      newName: $("newName"),
      addNameBtn: $("addNameBtn"),
      nameList: $("nameList"),
      openArchiveModal: $("openArchiveModal"),
      closeArchive: $("closeArchive"),
      archiveModal: $("archiveModal"),
      archiveFilter: $("archiveFilter"),
      archiveList: $("archiveList"),
      openDataModal: $("openDataModal"),
      closeData: $("closeData"),
      dataModal: $("dataModal"),
      exportBtn: $("exportBtn"),
      importBtn: $("importBtn"),
      importFile: $("importFile"),
      wipeBtn: $("wipeBtn"),
      openSettings: $("openSettings"),
      closeSettings: $("closeSettings"),
      settingsModal: $("settingsModal"),
      dateModal: $("dateModal"),
      readDateInput: $("readDateInput"),
      dateConfirm: $("dateConfirm"),
      dateCancel: $("dateCancel"),
      closeDateModal: $("closeDateModal"),
    };

    // ====== ìƒíƒœ ======
    const state = {
      names: [],
      records: []
    };

    // ====== ìœ í‹¸ ======
    function uid(){
      return "id_" + Date.now().toString(36) + "_" + Math.random().toString(36).slice(2,7);
    }
    function nowTs(){ return Date.now(); }
    function safeTrim(s){ return (s ?? "").toString().trim(); }
    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#39;");
    }

    // ====== ë°ì´í„° ë¡œë“œ/ì €ì¥ ======
    function load(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        if(raw){
          const obj = JSON.parse(raw);
          state.names = Array.isArray(obj.names) ? obj.names : [];
          state.records = Array.isArray(obj.records) ? obj.records : [];
        }
      }catch(e){
        state.names = [];
        state.records = [];
      }
    }

    function save(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify({names: state.names, records: state.records}));
    }

    function loadSettings(){
      try{
        const raw = localStorage.getItem(SETTINGS_KEY);
        return raw ? JSON.parse(raw) : {theme: 'light', fontScale: 1};
      }catch(e){
        return {theme: 'light', fontScale: 1};
      }
    }

    function saveSettings(s){
      localStorage.setItem(SETTINGS_KEY, JSON.stringify(s));
    }

    function applyTheme(theme){
      document.body.classList.toggle('theme-light', theme === 'light');
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', theme === 'light' ? '#f1f5f9' : '#0b0d10');
      document.querySelectorAll('.themeBtn[data-theme]').forEach(btn => {
        btn.classList.toggle('active', btn.getAttribute('data-theme') === theme);
      });
    }

    function applyFontScale(scale){
      document.documentElement.style.setProperty('--font-scale', scale);
      document.querySelectorAll('.themeBtn[data-scale]').forEach(btn => {
        btn.classList.toggle('active', parseFloat(btn.getAttribute('data-scale')) === scale);
      });
    }

    // ====== ê°„í–‰ë¬¼ ì´ë¦„ ê´€ë¦¬ ======
    function addName(name){
      const n = safeTrim(name);
      if(!n){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(state.names.includes(n)){ alert('ì´ë¯¸ ìˆëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
      state.names.push(n);
      state.names.sort();
      save();
      renderNameList();
      updateArchiveFilter();
      renderChecklist();
      els.newName.value = '';
      els.newName.focus();
    }

    function editName(oldName, newName){
      const n = safeTrim(newName);
      if(!n){ alert('ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }
      if(n === oldName) return;
      if(state.names.includes(n)){ alert('ì´ë¯¸ ìˆëŠ” ì´ë¦„ì…ë‹ˆë‹¤.'); return; }
      const idx = state.names.indexOf(oldName);
      if(idx >= 0) state.names[idx] = n;
      state.names.sort();
      state.records.forEach(r => { if(r.name === oldName) r.name = n; });
      save();
      renderNameList();
      updateArchiveFilter();
      renderChecklist();
      renderArchive();
    }

    function deleteName(name){
      const used = state.records.some(r => r.name === name);
      if(used){
        if(!confirm(`"${name}"ë¡œ ì €ì¥ëœ ê¸°ë¡ì´ ìˆìŠµë‹ˆë‹¤. ì‚­ì œí•˜ë©´ ëª©ë¡ì—ì„œë§Œ ì‚¬ë¼ì§€ê³  ê¸°ë¡ì€ ìœ ì§€ë©ë‹ˆë‹¤. ì‚­ì œí• ê¹Œìš”?`)) return;
      }else{
        if(!confirm(`"${name}"ì„(ë¥¼) ì‚­ì œí• ê¹Œìš”?`)) return;
      }
      state.names = state.names.filter(n => n !== name);
      save();
      renderNameList();
      updateArchiveFilter();
      renderChecklist();
    }

    function renderNameList(){
      if(!state.names.length){
        els.nameList.innerHTML = '<div class="hint">ë“±ë¡ëœ ê°„í–‰ë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      els.nameList.innerHTML = state.names.map((n, idx) => `
        <div class="nameRow" data-idx="${idx}">
          <span>${escapeHtml(n)}</span>
          <button class="small secondary" data-action="edit">í¸ì§‘</button>
          <button class="small danger" data-action="del">ì‚­ì œ</button>
        </div>
      `).join('');
    }

    function updateArchiveFilter(){
      const cur = els.archiveFilter.value;
      els.archiveFilter.innerHTML = '<option value="">ì „ì²´ ë³´ê¸°</option>' +
        state.names.map(n => `<option value="${escapeHtml(n)}">${escapeHtml(n)}</option>`).join('');
      if(state.names.includes(cur)) els.archiveFilter.value = cur;
    }

    // ====== ì²´í¬ë¦¬ìŠ¤íŠ¸ ë Œë” ======
    function renderChecklist(){
      const year = Number(els.year.value);
      const month = Number(els.month.value);
      if(!year || !month){
        els.checklist.innerHTML = '<div class="empty">ì—°ë„ì™€ ì›”ì„ ì„ íƒí•˜ì„¸ìš”.</div>';
        els.countLabel.textContent = '';
        return;
      }
      if(!state.names.length){
        els.checklist.innerHTML = '<div class="empty">ê°„í–‰ë¬¼ ì´ë¦„ì„ ë¨¼ì € ë“±ë¡í•˜ì„¸ìš”. (ê°„í–‰ë¬¼ ê´€ë¦¬ ë²„íŠ¼)</div>';
        els.countLabel.textContent = '';
        return;
      }

      const items = state.names.map(name => {
        const rec = state.records.find(r => r.name === name && r.year === year && r.month === month);
        const isRead = !!(rec && rec.isRead);
        const dateStr = rec && rec.readDate ? rec.readDate : '';
        const statusText = isRead ? (dateStr ? `ì½ìŒ: ${dateStr}` : 'ì½ìŒ') : 'ë¯¸ë…';
        const prefix = isRead ? 'âœ“ ' : '';

        return `
          <div class="magItem ${isRead ? 'read' : ''}" data-name="${escapeHtml(name)}">
            <div class="magInfo">
              <div class="magTitle">${prefix}${escapeHtml(name)} ${year}ë…„ ${month}ì›”í˜¸</div>
              <div class="magMeta">${statusText}</div>
            </div>
            <div class="actions">
              <button class="small ${isRead ? 'secondary' : 'ok'}" data-action="toggle">${isRead ? 'ì·¨ì†Œ' : 'ì½ìŒ ì²˜ë¦¬'}</button>
            </div>
          </div>
        `;
      }).join('');

      els.checklist.innerHTML = items;
      const readCount = state.names.filter(name => {
        const r = state.records.find(rec => rec.name === name && rec.year === year && rec.month === month);
        return r && r.isRead;
      }).length;
      els.countLabel.textContent = `${readCount}/${state.names.length} ì½ìŒ`;
    }

    // ====== ì½ìŒ í† ê¸€ ======
    let pendingToggleRecord = null; // ë‚ ì§œ ì„ íƒ ëŒ€ê¸° ì¤‘ì¸ ë ˆì½”ë“œ
    
    function toggleRead(name){
      console.log('[toggleRead] í•¨ìˆ˜ í˜¸ì¶œë¨! name:', name);
      const year = Number(els.year.value);
      const month = Number(els.month.value);
      
      if(!year || !month || !name) {
        alert('ì—°ë„, ì›”, ì´ë¦„ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      let rec = state.records.find(r => r.name === name && r.year === year && r.month === month);
      
      if(!rec){
        rec = {
          id: uid(),
          name,
          year,
          month,
          readDate: null,
          isRead: false,
          createdAt: nowTs(),
          updatedAt: nowTs()
        };
        state.records.push(rec);
      }

      if(rec.isRead){
        // ë¯¸ë…ìœ¼ë¡œ ì „í™˜
        rec.isRead = false;
        rec.readDate = null;
        rec.updatedAt = nowTs();
        save();
        renderChecklist();
        if(els.archiveModal.classList.contains('show')) renderArchive();
      }else{
        // ì½ìŒìœ¼ë¡œ ì „í™˜ - ë‚ ì§œ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
        console.log('[ëª¨ë‹¬ ì—´ê¸°] dateModal:', els.dateModal);
        pendingToggleRecord = rec;
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth()+1).padStart(2,"0");
        const dd = String(today.getDate()).padStart(2,"0");
        const defaultDate = `${yyyy}-${mm}-${dd}`;
        els.readDateInput.value = defaultDate;
        
        // ëª¨ë‹¬ í‘œì‹œ
        if(els.dateModal){
          els.dateModal.classList.add('show');
          console.log('[ëª¨ë‹¬] show í´ë˜ìŠ¤ ì¶”ê°€ë¨');
          // ëª¨ë‹¬ì´ ë³´ì´ëŠ”ì§€ í™•ì¸
          setTimeout(() => {
            const isVisible = els.dateModal.classList.contains('show');
            console.log('[ëª¨ë‹¬] 1ì´ˆ í›„ show í´ë˜ìŠ¤ ì¡´ì¬:', isVisible);
            const computedStyle = window.getComputedStyle(els.dateModal);
            console.log('[ëª¨ë‹¬] display:', computedStyle.display);
          }, 1000);
        }else{
          alert('ë‚ ì§œ ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
        }
      }
    }

    // ====== ë‚ ì§œ ì„ íƒ í™•ì¸ ======
    function confirmDateSelection(){
      if(!pendingToggleRecord) return;
      const selectedDate = els.readDateInput.value;
      if(!selectedDate){
        alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }
      pendingToggleRecord.isRead = true;
      pendingToggleRecord.readDate = selectedDate;
      pendingToggleRecord.updatedAt = nowTs();
      save();
      renderChecklist();
      if(els.archiveModal.classList.contains('show')) renderArchive();
      els.dateModal.classList.remove('show');
      pendingToggleRecord = null;
    }

    // ====== ë‚ ì§œ ì„ íƒ ì·¨ì†Œ ======
    function cancelDateSelection(){
      els.dateModal.classList.remove('show');
      pendingToggleRecord = null;
    }

    // ====== ë³´ê´€í•¨ ë Œë” ======
    function renderArchive(){
      const filterName = els.archiveFilter.value;
      let arr = [...state.records];
      if(filterName) arr = arr.filter(r => r.name === filterName);
      arr.sort((a,b) => (b.year * 100 + b.month) - (a.year * 100 + a.month));

      if(!arr.length){
        els.archiveList.innerHTML = '<div class="empty">ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      els.archiveList.innerHTML = arr.map(r => {
        const statusText = r.isRead ? (r.readDate ? `ì½ìŒ: ${r.readDate}` : 'ì½ìŒ') : 'ë¯¸ë…';
        const prefix = r.isRead ? 'âœ“ ' : '';
        return `
          <div class="magItem ${r.isRead ? 'read' : ''}">
            <div class="magInfo">
              <div class="magTitle">${prefix}${escapeHtml(r.name)} ${r.year}ë…„ ${r.month}ì›”í˜¸</div>
              <div class="magMeta">${statusText}</div>
            </div>
            <div class="actions">
              <button class="small danger" data-action="delRec" data-id="${r.id}">ì‚­ì œ</button>
            </div>
          </div>
        `;
      }).join('');
    }

    function deleteRecord(id){
      if(!confirm('ì´ ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?')) return;
      state.records = state.records.filter(r => r.id !== id);
      save();
      renderArchive();
      renderChecklist();
    }

    // ====== ë°±ì—…/ë³µì› ======
    function exportJson(){
      const payload = {
        app: "mag_checklist_v1",
        exportedAt: new Date().toISOString(),
        names: state.names,
        records: state.records
      };
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `ì •ê¸°ê°„í–‰ë¬¼_ë°±ì—…_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function importJson(file){
      const reader = new FileReader();
      reader.onload = () => {
        try{
          const obj = JSON.parse(reader.result);
          const inNames = Array.isArray(obj.names) ? obj.names : [];
          const inRecs = Array.isArray(obj.records) ? obj.records : [];
          
          const ok = confirm(`ê°€ì ¸ì˜¤ê¸°: ê°„í–‰ë¬¼ ${inNames.length}ê°œ, ê¸°ë¡ ${inRecs.length}ê°œ\nê¸°ì¡´ ë°ì´í„°ë¥¼ ìœ ì§€í•˜ê³  í•©ì¹ ê¹Œìš”? (ì·¨ì†Œ=ë®ì–´ì“°ê¸°)`);
          
          if(ok){
            state.names = [...new Set([...state.names, ...inNames])].sort();
            const existingIds = new Set(state.records.map(r=>r.id));
            inRecs.forEach(r=>{
              if(existingIds.has(r.id)) r.id = uid();
              state.records.push(r);
            });
          }else{
            state.names = inNames;
            state.records = inRecs;
          }

          save();
          renderNameList();
          updateArchiveFilter();
          renderChecklist();
          alert('ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ!');
        }catch(e){
          alert('ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨: ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
        }
      };
      reader.readAsText(file, "utf-8");
    }

    function wipeAll(){
      if(!confirm('ëª¨ë“  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”? (ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤)')) return;
      state.names = [];
      state.records = [];
      save();
      renderNameList();
      updateArchiveFilter();
      renderChecklist();
      alert('ì‚­ì œ ì™„ë£Œ');
    }

    // ====== ì´ë²¤íŠ¸ ======
    els.year.addEventListener('change', renderChecklist);
    els.month.addEventListener('change', renderChecklist);

    els.checklist.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      const item = btn.closest('.magItem');
      if(!item) return;
      const name = item.getAttribute('data-name');
      if(action === 'toggle') toggleRead(name);
    });

    els.openNamesModal.addEventListener('click', () => {
      renderNameList();
      els.namesModal.classList.add('show');
      els.newName.value = '';
      els.newName.focus();
    });
    els.closeNames.addEventListener('click', () => els.namesModal.classList.remove('show'));
    els.namesModal.addEventListener('click', (e) => {
      if(e.target === els.namesModal) els.namesModal.classList.remove('show');
    });

    els.addNameBtn.addEventListener('click', () => addName(els.newName.value));
    els.newName.addEventListener('keypress', (e) => {
      if(e.key === 'Enter') addName(els.newName.value);
    });

    els.nameList.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      const row = e.target.closest('.nameRow');
      if(!btn || !row) return;
      const idx = parseInt(row.getAttribute('data-idx'), 10);
      if(isNaN(idx) || idx < 0 || idx >= state.names.length) return;
      const name = state.names[idx];
      const action = btn.getAttribute('data-action');
      if(action === 'edit'){
        const newName = prompt('ìƒˆ ì´ë¦„', name);
        if(newName != null) editName(name, newName);
      }else if(action === 'del'){
        deleteName(name);
      }
    });

    els.openArchiveModal.addEventListener('click', () => {
      updateArchiveFilter();
      renderArchive();
      els.archiveModal.classList.add('show');
    });
    els.closeArchive.addEventListener('click', () => els.archiveModal.classList.remove('show'));
    els.archiveModal.addEventListener('click', (e) => {
      if(e.target === els.archiveModal) els.archiveModal.classList.remove('show');
    });

    els.archiveFilter.addEventListener('change', renderArchive);
    els.archiveList.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if(!btn) return;
      const action = btn.getAttribute('data-action');
      const id = btn.getAttribute('data-id');
      if(action === 'delRec' && id) deleteRecord(id);
    });

    els.openDataModal.addEventListener('click', () => els.dataModal.classList.add('show'));
    els.closeData.addEventListener('click', () => els.dataModal.classList.remove('show'));
    els.dataModal.addEventListener('click', (e) => {
      if(e.target === els.dataModal) els.dataModal.classList.remove('show');
    });

    els.exportBtn.addEventListener('click', exportJson);
    els.importBtn.addEventListener('click', () => els.importFile.click());
    els.importFile.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if(file) importJson(file);
      els.importFile.value = '';
    });
    els.wipeBtn.addEventListener('click', wipeAll);

    els.openSettings.addEventListener('click', () => els.settingsModal.classList.add('show'));
    els.closeSettings.addEventListener('click', () => els.settingsModal.classList.remove('show'));
    els.settingsModal.addEventListener('click', (e) => {
      if(e.target === els.settingsModal) els.settingsModal.classList.remove('show');
    });

    // ë‚ ì§œ ì„ íƒ ëª¨ë‹¬
    els.dateConfirm.addEventListener('click', confirmDateSelection);
    els.dateCancel.addEventListener('click', cancelDateSelection);
    els.closeDateModal.addEventListener('click', cancelDateSelection);
    els.dateModal.addEventListener('click', (e) => {
      if(e.target === els.dateModal) cancelDateSelection();
    });

    document.querySelectorAll('.themeBtn[data-theme]').forEach(btn => {
      btn.addEventListener('click', () => {
        const theme = btn.getAttribute('data-theme');
        applyTheme(theme);
        const s = loadSettings();
        s.theme = theme;
        saveSettings(s);
      });
    });

    document.querySelectorAll('.themeBtn[data-scale]').forEach(btn => {
      btn.addEventListener('click', () => {
        const scale = parseFloat(btn.getAttribute('data-scale'));
        applyFontScale(scale);
        const s = loadSettings();
        s.fontScale = scale;
        saveSettings(s);
      });
    });

    document.addEventListener('keydown', (e) => {
      if(e.key !== 'Escape') return;
      if(els.dateModal.classList.contains('show')) cancelDateSelection();
      else if(els.settingsModal.classList.contains('show')) els.settingsModal.classList.remove('show');
      else if(els.namesModal.classList.contains('show')) els.namesModal.classList.remove('show');
      else if(els.archiveModal.classList.contains('show')) els.archiveModal.classList.remove('show');
      else if(els.dataModal.classList.contains('show')) els.dataModal.classList.remove('show');
    });

    // ====== ì‹œì‘ ======
    const settings = loadSettings();
    applyTheme(settings.theme);
    applyFontScale(settings.fontScale);

    load();
    
    const today = new Date();
    els.year.value = today.getFullYear();
    els.month.value = String(today.getMonth() + 1);

    renderNameList();
    updateArchiveFilter();
    renderChecklist();

    // PWA: Service Worker ì„ì‹œ ë¹„í™œì„±í™” (ìºì‹œ ë¬¸ì œ í•´ê²°ìš©)
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(registrations => {
        for(let registration of registrations) {
          registration.unregister();
          console.log('ê¸°ì¡´ SW ì œê±°ë¨');
        }
      });
    }
  </script>
</body>
</html>
